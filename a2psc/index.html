<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Raj Sales Tracker Pro v2</title>
  <meta name="theme-color" content="#0f172a">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Plus Jakarta Sans"', 'sans-serif'],
          },
          colors: {
            dark: {
              900: '#0B0F19',
              800: '#111827',
              700: '#1F2937',
            },
            accent: {
              gold: '#FBBF24',
              primary: '#6366f1', // Indigo
            }
          },
          animation: {
            'fade-in': 'fadeIn 0.4s ease-out',
            'slide-up': 'slideUp 0.4s ease-out',
          },
          keyframes: {
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            slideUp: {
              '0%': { opacity: '0', transform: 'translateY(20px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #111827; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 4px; border: 2px solid #111827; }
    ::-webkit-scrollbar-thumb:hover { background: #4B5563; }

    /* Background Mesh Cleaner */
    .mesh-bg {
      background-color: #0f172a;
      background-image: 
        radial-gradient(circle at 15% 50%, rgba(99, 102, 241, 0.08), transparent 25%), 
        radial-gradient(circle at 85% 30%, rgba(244, 63, 94, 0.08), transparent 25%);
      min-height: 100vh;
    }

    /* Glass Components Improved */
    .glass-panel {
      background: rgba(30, 41, 59, 0.7);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    .input-field {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.2s ease;
    }
    .input-field:focus {
      background: rgba(15, 23, 42, 0.9);
      border-color: #FBBF24;
      box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.15);
      outline: none;
    }

    /* Table Sticky Header */
    .sticky-header th {
      position: sticky;
      top: 0;
      z-index: 20;
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(4px);
    }
  </style>
</head>
<body class="mesh-bg text-slate-300 font-sans antialiased selection:bg-amber-500/30 selection:text-amber-200">

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-6 right-6 z-[100] hidden transform transition-all duration-300 translate-y-10 opacity-0">
    <div class="glass-panel rounded-xl p-4 flex items-center gap-4 shadow-2xl border-l-4 border-emerald-500 bg-dark-800">
      <div class="bg-emerald-500/10 p-2 rounded-lg text-emerald-400">
        <span id="toastIcon" class="text-xl"></span>
      </div>
      <div>
        <h4 id="toastTitle" class="text-sm font-bold text-white">Success</h4>
        <p id="toastMessage" class="text-xs text-slate-400 mt-0.5">Action completed.</p>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="sticky top-0 z-40 border-b border-white/5 bg-[#0f172a]/90 backdrop-blur-xl">
    <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-lg bg-gradient-to-br from-amber-400 to-orange-600 flex items-center justify-center shadow-lg shadow-orange-500/20 text-black font-bold text-lg tracking-tighter">MR</div>
          <div>
            <h1 class="text-white font-bold text-lg tracking-tight leading-none">Mi Raj <span class="text-amber-400 font-normal">Tracker</span></h1>
          </div>
        </div>

        <!-- Top Actions -->
        <div class="flex items-center gap-3">
          <div class="hidden md:flex items-center bg-white/5 rounded-full px-3 py-1.5 border border-white/5">
            <div class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse mr-2"></div>
            <span class="text-xs font-medium text-slate-400">System Online</span>
          </div>
          
          <div class="relative group">
            <button id="menuBtn" class="flex items-center gap-2 px-3 py-2 rounded-lg bg-white/5 hover:bg-white/10 border border-white/5 text-sm font-medium text-white transition-all">
              <span>Menu</span>
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            
            <!-- Dropdown -->
            <div id="menu" class="absolute right-0 mt-2 w-48 glass-panel rounded-xl shadow-2xl py-1 hidden transform origin-top-right transition-all z-50 bg-dark-800">
              <button id="importBtn" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-white/5 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg> Import CSV
              </button>
              <button id="exportAllBtn" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-white/5 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> Export All
              </button>
              <button id="targetBtn" class="w-full text-left px-4 py-2.5 text-sm text-slate-300 hover:bg-white/5 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg> Set Target
              </button>
              <div class="h-px bg-white/10 my-1"></div>
              <button id="resetBtn" class="w-full text-left px-4 py-2.5 text-sm text-rose-500 hover:bg-rose-500/10 flex items-center gap-2">
                <svg class="w-4 h-4 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> Reset Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-6">
    
    <!-- Stats Grid (Improved) -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6 animate-slide-up">
      <!-- Card 1: Revenue -->
      <div class="glass-panel rounded-xl p-5 relative overflow-hidden group">
        <div class="absolute right-0 top-0 w-32 h-32 bg-emerald-500/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
        <div class="relative z-10">
          <p class="text-xs font-bold text-emerald-400 uppercase tracking-wider mb-1 flex items-center gap-2">
            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400"></span> Total Revenue
          </p>
          <h3 id="statRevenue" class="text-2xl lg:text-3xl font-bold text-white tracking-tight mt-1">Rp 0</h3>
          <p id="statRevChange" class="text-[11px] mt-2 font-medium text-slate-500">- vs prev month</p>
        </div>
      </div>

      <!-- Card 2: Sales -->
      <div class="glass-panel rounded-xl p-5 relative overflow-hidden group">
        <div class="absolute right-0 top-0 w-32 h-32 bg-blue-500/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
        <div class="grid grid-cols-2 gap-4 relative z-10 h-full items-center">
          <div>
            <p class="text-[10px] font-bold text-blue-400 uppercase tracking-wider mb-1">Sales Closed</p>
            <h3 id="statSales" class="text-2xl font-bold text-white">0</h3>
          </div>
          <div class="text-right pl-4 border-l border-white/5">
             <p class="text-[10px] font-bold text-indigo-400 uppercase tracking-wider mb-1">Conversion</p>
             <h3 id="statConversion" class="text-xl font-bold text-white">0%</h3>
          </div>
        </div>
      </div>

      <!-- Card 3: Bonus -->
      <div class="glass-panel rounded-xl p-5 relative overflow-hidden group">
        <div class="absolute right-0 top-0 w-32 h-32 bg-pink-500/10 rounded-bl-full -mr-8 -mt-8 transition-transform group-hover:scale-110"></div>
        <div class="relative z-10">
          <div class="flex justify-between items-center mb-2">
            <p class="text-xs font-bold text-pink-400 uppercase tracking-wider">Bonus Est.</p>
            <span id="bonusLevel" class="bg-white/5 text-slate-300 text-[10px] px-2 py-0.5 rounded border border-white/10">Lvl 1</span>
          </div>
          <h3 id="statBonus" class="text-2xl font-bold text-white">Rp 0</h3>
          <div class="w-full bg-dark-900 h-1 rounded-full mt-3 overflow-hidden">
            <div id="bonusBar" class="h-full bg-gradient-to-r from-pink-500 to-rose-500 w-0 transition-all duration-500"></div>
          </div>
        </div>
      </div>

      <!-- Card 4: Operational -->
      <div class="glass-panel rounded-xl p-5 relative overflow-hidden flex flex-col justify-between">
        <div class="flex justify-between items-start">
          <div>
            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Total TC</p>
            <p id="statTcTotal" class="text-xl font-bold text-white">0</p>
          </div>
          <div class="text-right">
            <p class="text-[10px] text-slate-500 font-bold uppercase mb-1">Pending</p>
            <p id="statPending" class="text-xl font-bold text-amber-400">0</p>
          </div>
        </div>
        <div class="flex justify-between items-end mt-2">
             <div>
                <p class="text-[10px] text-slate-500 font-bold uppercase mb-0.5">Avg Order</p>
                <p id="statAov" class="text-xs font-mono text-slate-300">Rp 0</p>
             </div>
             <div class="text-right">
                <p class="text-[10px] text-slate-500 font-bold uppercase mb-0.5">TC Salary</p>
                <p id="statTcSalary" class="text-xs font-mono text-cyan-400">Rp 0</p>
             </div>
        </div>
      </div>
    </div>

    <!-- Target Section (Dynamic) -->
    <div id="targetSection" class="hidden mb-6 animate-fade-in">
      <div class="bg-gradient-to-r from-amber-500/20 to-orange-600/10 border border-amber-500/20 rounded-xl p-4 flex flex-col md:flex-row items-center gap-4">
         <div class="flex-1 w-full">
            <div class="flex justify-between items-end mb-2">
                <span class="text-xs font-bold text-amber-400 uppercase">Monthly Goal</span>
                <span class="text-xs text-slate-400"><span id="targetCurrent" class="text-white font-bold">Rp 0</span> / <span id="targetDesc">Rp 0</span></span>
            </div>
            <div class="h-3 bg-dark-900 rounded-full overflow-hidden border border-white/5">
               <div id="targetProgress" class="h-full bg-gradient-to-r from-amber-400 to-orange-500 rounded-full transition-all duration-1000 ease-out relative w-0">
                  <div class="absolute inset-0 bg-white/20 w-full h-full animate-[shimmer_2s_infinite]"></div>
               </div>
            </div>
         </div>
         <div class="text-center md:text-right min-w-[100px]">
            <span id="targetPercent" class="text-2xl font-black text-white">0%</span>
            <p class="text-[10px] text-slate-500 uppercase">Achieved</p>
         </div>
      </div>
    </div>

    <!-- Workspace Area -->
    <div class="grid lg:grid-cols-12 gap-6 h-full items-start">
      
      <!-- LEFT PANEL: Form & Filters (Fixed Height on Desktop usually, simplified here) -->
      <div class="lg:col-span-4 xl:col-span-3 flex flex-col gap-5">
        
        <!-- Filters Card -->
        <div class="glass-panel rounded-xl p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-sm font-bold text-white flex items-center gap-2">
              <svg class="w-4 h-4 text-indigo-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
              Filter Data
            </h3>
            <button id="refreshBtn" class="p-1.5 rounded hover:bg-white/5 text-slate-500 hover:text-amber-400 transition-colors" title="Refresh">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
          </div>

          <div class="space-y-3">
            <div class="relative group">
              <svg class="w-4 h-4 absolute left-3 top-2.5 text-slate-500 group-focus-within:text-amber-400 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
              <input id="searchInput" type="text" placeholder="Search name, course, note..." class="w-full input-field rounded-lg pl-9 pr-3 py-2 text-xs text-white placeholder-slate-500">
            </div>

            <div class="grid grid-cols-2 gap-2">
              <select id="monthSelector" class="input-field rounded-lg px-3 py-2 text-xs text-slate-300"></select>
              <select id="periodFilter" class="input-field rounded-lg px-3 py-2 text-xs text-slate-300">
                <option value="">All Period</option>
                <option value="P1">P1 (1-15)</option>
                <option value="P2">P2 (16-31)</option>
              </select>
            </div>

            <select id="statusFilter" class="w-full input-field rounded-lg px-3 py-2 text-xs text-slate-300">
              <option value="">All Statuses</option>
              <option value="Buy">‚úÖ Buy</option>
              <option value="Not">‚ùå Not Buy</option>
              <option value="Pending">‚è≥ Pending</option>
            </select>
            
             <select id="courseFilter" class="w-full input-field rounded-lg px-3 py-2 text-xs text-slate-300">
              <option value="">All Courses</option>
            </select>

            <div class="pt-3 border-t border-white/5 flex justify-between items-center">
               <span id="recordCount" class="text-[10px] text-slate-500 font-mono bg-white/5 px-2 py-0.5 rounded">0 records</span>
               <button id="exportCurrentBtn" class="text-[10px] text-amber-500 hover:text-amber-400 font-bold uppercase tracking-wider hover:underline">Export CSV</button>
            </div>
          </div>
        </div>

        <!-- Entry Form -->
        <div class="glass-panel rounded-xl p-5 flex-1 border-t-4 border-t-amber-500">
          <div class="flex items-center justify-between mb-5">
            <h3 class="text-sm font-bold text-white flex items-center gap-2">
              <span id="formTitleIcon" class="text-amber-400 bg-amber-400/10 p-1 rounded">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
              </span>
              <span id="formTitle">New Record</span>
            </h3>
            <button id="clearFormBtn" class="text-[10px] uppercase tracking-wider font-bold text-slate-500 hover:text-white transition-colors bg-white/5 px-2 py-1 rounded">Clear</button>
          </div>

          <form id="entryForm" class="space-y-4">
            <input type="hidden" id="editingId">
            
            <!-- Row 1 -->
            <div class="grid grid-cols-2 gap-3">
               <div class="space-y-1.5">
                 <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider ml-1">Date <span class="text-rose-500">*</span></label>
                 <input id="date" type="date" required class="w-full input-field rounded-lg px-3 py-2 text-xs text-white">
               </div>
               <div class="space-y-1.5">
                 <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider ml-1">Time</label>
                 <input id="time" type="time" class="w-full input-field rounded-lg px-3 py-2 text-xs text-white">
               </div>
            </div>

            <!-- Row 2 -->
            <div class="space-y-1.5">
               <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider ml-1">Student Name</label>
               <input id="childName" type="text" placeholder="e.g. Alexander The Great" class="w-full input-field rounded-lg px-3 py-2.5 text-sm text-white placeholder-slate-600 focus:ring-1 focus:ring-amber-500">
            </div>

            <!-- Row 3 -->
             <div class="space-y-1.5">
               <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider ml-1">CRM Link</label>
               <div class="relative">
                 <input id="crm" type="url" placeholder="https://crm..." class="w-full input-field rounded-lg pl-8 pr-3 py-2 text-xs text-blue-400 placeholder-slate-700">
                 <svg class="w-3.5 h-3.5 absolute left-3 top-2.5 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1"></path></svg>
               </div>
            </div>

            <!-- Row 4 -->
            <div class="grid grid-cols-2 gap-3">
               <div class="space-y-1.5">
                 <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider ml-1">Course <span class="text-rose-500">*</span></label>
                 <select id="course" required class="w-full input-field rounded-lg px-2 py-2 text-xs text-white">
                   <option value="">Select...</option>
                    <option value="Coding Knight">Coding Knight</option>
                    <option value="Digital Literasi">Digital Literasi</option>
                    <option value="Visual Programming">Visual Programming</option>
                    <option value="Graphic Design Junior">Graphic Design Junior</option>
                    <option value="Graphic Design Senior">Graphic Design Senior</option>
                    <option value="Game Design">Game Design</option>
                    <option value="Python Start">Python Start</option>
                    <option value="Python Pro">Python Pro</option>
                    <option value="Math Explorers">Math Explorers</option>
                    <option value="Math Masters">Math Masters</option>
                    <option value="Course AI">Course AI</option>
                    <option value="Math Tutoring">Math Tutoring</option>
                 </select>
               </div>
               <div class="space-y-1.5">
                 <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider ml-1">Status <span class="text-rose-500">*</span></label>
                 <select id="buyOrNot" required class="w-full input-field rounded-lg px-2 py-2 text-xs text-white">
                   <option value="">Select...</option>
                   <option value="Buy">‚úÖ Buy</option>
                   <option value="Not">‚ùå Not Buy</option>
                   <option value="Pending">‚è≥ Pending</option>
                 </select>
               </div>
            </div>

            <!-- Row 5 -->
            <div class="grid grid-cols-2 gap-3">
              <div class="space-y-1.5">
                 <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider ml-1">Revenue</label>
                 <div class="relative">
                   <span class="absolute left-3 top-2 text-xs text-emerald-500 font-bold">Rp</span>
                   <input id="revenue" type="number" placeholder="0" class="w-full input-field rounded-lg pl-9 pr-3 py-2 text-xs text-white font-mono placeholder-slate-700 focus:border-emerald-500">
                 </div>
               </div>
               <div class="space-y-1.5">
                 <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider ml-1">Layer</label>
                 <select id="layer" class="w-full input-field rounded-lg px-2 py-2 text-xs text-white">
                   <option value="">-</option>
                   <option value="TCP">TCP</option>
                   <option value="ND">ND</option>
                   <option value="PP">PP</option>
                   <option value="Other">Other</option>
                 </select>
               </div>
            </div>

            <!-- Row 6: Note -->
            <div class="space-y-1.5">
               <label class="text-[10px] uppercase text-slate-400 font-bold tracking-wider ml-1 flex justify-between">
                 <span>Note</span>
                 <span class="text-[9px] text-slate-600 normal-case">Optional details</span>
               </label>
               <textarea id="note" rows="3" placeholder="Write important details here..." class="w-full input-field rounded-lg px-3 py-2 text-xs text-white placeholder-slate-600 resize-none"></textarea>
            </div>

            <div class="pt-2 flex gap-2">
              <button type="submit" class="flex-1 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-black font-bold py-2.5 rounded-lg shadow-lg shadow-orange-500/20 transition-all transform hover:-translate-y-0.5 active:translate-y-0 text-sm flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4"></path></svg>
                Save Record
              </button>
              <button type="button" id="duplicateBtn" class="hidden w-12 flex items-center justify-center bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors" title="Duplicate">
                 <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
              </button>
            </div>
          </form>
        </div>
      </div>

      <!-- RIGHT PANEL: Table -->
      <div class="lg:col-span-8 xl:col-span-9 flex flex-col h-full min-h-[600px]">
        <div class="glass-panel rounded-xl flex-1 flex flex-col overflow-hidden border-0 ring-1 ring-white/10 shadow-2xl">
          <!-- Table Header Actions -->
          <div class="p-4 border-b border-white/5 flex justify-between items-center bg-dark-800/40">
            <div class="flex items-center gap-3">
              <span id="selectedMonth" class="text-sm font-bold text-white"></span>
              <span id="selectedPeriod" class="text-[10px] font-bold uppercase text-amber-400 bg-amber-400/10 px-2 py-0.5 rounded border border-amber-400/20"></span>
            </div>
            <div class="flex items-center gap-3">
              <button id="chartBtn" class="flex items-center gap-1.5 text-xs font-medium text-slate-400 hover:text-white transition-colors px-3 py-1.5 rounded hover:bg-white/5">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg>
                Analytics
              </button>
              <button id="bulkDeleteBtn" class="hidden items-center gap-1.5 px-3 py-1.5 bg-rose-500/10 text-rose-400 border border-rose-500/20 hover:bg-rose-500/20 rounded text-xs font-bold transition-all">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Delete (<span id="selectedCount">0</span>)
              </button>
            </div>
          </div>

          <!-- Actual Table -->
          <div class="overflow-auto flex-1 relative">
             <!-- Empty State -->
            <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-center p-8 z-10">
              <div class="w-20 h-20 bg-slate-800/50 rounded-full flex items-center justify-center mb-4 ring-1 ring-white/5">
                <svg class="w-10 h-10 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
              </div>
              <h3 class="text-white font-bold text-lg mb-1">No Data Found</h3>
              <p class="text-slate-500 text-sm max-w-xs mx-auto">There are no records for this period. Try adjusting filters or add a new sale.</p>
            </div>

            <table class="w-full text-left border-collapse">
              <thead class="bg-dark-900 text-[11px] text-slate-500 uppercase tracking-wider sticky-header shadow-sm">
                <tr>
                  <th class="p-4 w-12 text-center"><input type="checkbox" id="selectAll" class="rounded border-slate-600 bg-transparent focus:ring-0 text-amber-500 w-4 h-4 cursor-pointer"></th>
                  <th class="p-4 cursor-pointer hover:text-amber-400 transition-colors group" data-sort="date">
                    Date <span class="invisible group-hover:visible">‚Üï</span>
                  </th>
                  <th class="p-4">Student</th>
                  <th class="p-4">Course</th>
                  <th class="p-4 cursor-pointer hover:text-amber-400 transition-colors group" data-sort="buyOrNot">
                    Status <span class="invisible group-hover:visible">‚Üï</span>
                  </th>
                  <th class="p-4 cursor-pointer hover:text-amber-400 transition-colors group" data-sort="revenue">
                    Revenue <span class="invisible group-hover:visible">‚Üï</span>
                  </th>
                  <th class="p-4 w-1/5">Note</th> <!-- NEW COLUMN -->
                  <th class="p-4 text-right w-24 bg-dark-900 sticky right-0 z-20 shadow-[-5px_0_10px_rgba(0,0,0,0.1)]">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody" class="text-sm text-slate-300 divide-y divide-white/5">
                <!-- Rows injected via JS -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- MODALS -->
  
  <!-- Backdrop -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-40 hidden transition-opacity duration-300"></div>

  <!-- Chart Modal -->
  <div id="chartModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-4xl bg-[#0F172A] border border-white/10 rounded-2xl shadow-2xl flex flex-col max-h-[90vh] transform transition-all scale-95 opacity-0 modal-content">
      <div class="p-5 border-b border-white/5 flex justify-between items-center bg-dark-800">
        <h3 class="text-lg font-bold text-white">Analytics Dashboard</h3>
        <button id="closeChartBtn" class="text-slate-500 hover:text-white text-xl">‚úï</button>
      </div>
      <div class="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6 bg-[#0B0F19]">
         <div class="glass-panel p-5 rounded-xl border-t border-white/5">
           <h4 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Status Distribution</h4>
           <div id="statusChart" class="h-48 flex items-end justify-center gap-4 pb-4 border-b border-white/5"></div>
         </div>
         <div class="glass-panel p-5 rounded-xl border-t border-white/5">
           <h4 class="text-xs font-bold text-slate-400 uppercase mb-4 tracking-wider">Course Performance</h4>
           <div id="courseBreakdown" class="space-y-3 max-h-48 overflow-y-auto pr-2 custom-scrollbar"></div>
         </div>
      </div>
    </div>
  </div>

  <!-- Target Modal -->
  <div id="targetModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-md bg-[#0F172A] border border-amber-500/30 rounded-2xl shadow-2xl p-6 modal-content transform scale-95 opacity-0 transition-all">
       <h3 class="text-lg font-bold text-white mb-2">üéØ Set Monthly Target</h3>
       <p class="text-xs text-slate-400 mb-6">Define your revenue goal for this month to track progress.</p>
       
       <label class="block text-xs font-bold text-amber-500 uppercase mb-2">Target Amount (IDR)</label>
       <div class="relative mb-8">
         <span class="absolute left-4 top-3.5 text-slate-500 text-lg">Rp</span>
         <input id="targetInput" type="number" class="w-full bg-dark-900 border border-white/10 rounded-xl pl-12 pr-4 py-3 text-xl font-bold text-white focus:border-amber-500 outline-none focus:ring-1 focus:ring-amber-500" placeholder="50000000">
       </div>
       
       <div class="flex justify-end gap-3">
         <button id="cancelTargetBtn" class="px-4 py-2 text-slate-400 hover:text-white text-sm font-medium">Cancel</button>
         <button id="saveTargetBtn" class="px-6 py-2 bg-amber-500 hover:bg-amber-400 text-black font-bold rounded-lg text-sm shadow-lg shadow-amber-500/20">Save Target</button>
       </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-md bg-[#0F172A] border border-white/10 rounded-2xl shadow-2xl p-6 modal-content transform scale-95 opacity-0 transition-all">
       <h3 class="text-lg font-bold text-white mb-2">üì• Import CSV</h3>
       <p class="text-xs text-slate-400 mb-4">Upload a standard CSV file generated by this app.</p>
       <div class="border-2 border-dashed border-white/10 rounded-xl p-8 text-center hover:border-amber-500/50 hover:bg-white/5 transition-all cursor-pointer relative group">
         <input type="file" id="importFile" accept=".csv" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full z-10">
         <div class="pointer-events-none">
            <svg class="w-10 h-10 mx-auto text-slate-600 group-hover:text-amber-500 mb-3 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
            <span class="text-sm text-slate-300 font-medium group-hover:text-white">Click to upload CSV</span>
            <p class="text-xs text-slate-600 mt-1">or drag and drop here</p>
         </div>
       </div>
       <div class="flex justify-end gap-3 mt-6">
         <button id="cancelImportBtn" class="px-4 py-2 text-slate-400 hover:text-white text-sm font-medium">Cancel</button>
         <button id="confirmImportBtn" class="px-5 py-2 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-lg text-sm">Process Import</button>
       </div>
    </div>
  </div>

  <!-- Reset Modal -->
  <div id="pwModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-sm bg-[#0F172A] border border-rose-500/30 rounded-2xl shadow-2xl p-6 modal-content transform scale-95 opacity-0 transition-all">
      <div class="flex items-center gap-3 mb-4 text-rose-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        <h3 class="text-lg font-bold text-white">Factory Reset</h3>
      </div>
       <p class="text-sm text-slate-400 mb-4">This will permanently delete <strong>ALL</strong> data. This action cannot be undone.</p>
       <input id="pwInput" type="password" class="w-full bg-dark-900 border border-white/10 rounded-lg p-3 text-white focus:border-rose-500 outline-none mb-6 text-sm" placeholder="Enter password to confirm...">
       <div class="flex justify-end gap-3">
         <button id="cancelPwBtn" class="px-4 py-2 text-slate-400 hover:text-white text-sm">Cancel</button>
         <button id="confirmPwBtn" class="px-4 py-2 bg-rose-600 hover:bg-rose-500 text-white font-bold rounded-lg text-sm shadow-lg shadow-rose-900/20">Delete Everything</button>
       </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    // --- CONFIG & CONSTANTS ---
    const STORAGE_KEY = 'mrj_sales_v2';
    const TARGET_KEY = 'mrj_target_v2';
    const RESET_PASSWORD = 'resetozeromrj';
    const DOLLAR_RATE = 16000;
    const SALES_COMMISSION_USD = 2.5;

    const COURSES = [
      'Coding Knight', 'Digital Literasi', 'Visual Programming',
      'Graphic Design Junior', 'Graphic Design Senior', 'Game Design',
      'Python Start', 'Python Pro', 'Math Explorers', 'Math Masters',
      'Course AI', 'Math Tutoring'
    ];

    // Utility Functions
    const uid = () => 'id-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9);
    
    const formatRp = (num) => {
      if (num === null || num === undefined || num === '') return 'Rp 0';
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(Number(num));
    };

    const showToast = (title, message = '', icon = '‚úÖ', ms = 3000) => {
      const toast = document.getElementById('toast');
      document.getElementById('toastTitle').textContent = title;
      document.getElementById('toastMessage').textContent = message;
      document.getElementById('toastIcon').textContent = icon;
      
      toast.classList.remove('hidden');
      requestAnimationFrame(() => {
        toast.classList.remove('translate-y-10', 'opacity-0');
      });

      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => {
        toast.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, ms);
    };

    // --- BUSINESS LOGIC ---
    function calculateBonus(revenue, conversion) {
      if (!conversion) return { amount: 0, percent: 0, level: 'Lvl 1', progress: 0 };
      
      let percent = 0;
      // Simplified logic based on original request ranges
      if (revenue <= 16830000) percent = conversion < 30 ? 4.5 : (conversion < 50 ? 6.0 : 7.0);
      else if (revenue <= 33660000) percent = conversion < 30 ? 5.5 : (conversion < 50 ? 7.0 : 8.0);
      else if (revenue <= 50490000) percent = conversion < 30 ? 7.0 : (conversion < 50 ? 9.0 : 10.5);
      else if (revenue <= 67320000) percent = conversion < 30 ? 8.5 : (conversion < 50 ? 11.5 : 13.0);
      else percent = conversion < 30 ? 10.5 : (conversion < 50 ? 13.5 : 15.0);

      let level = 'Lvl 1', progress = 20;
      if (revenue > 67320000) { level = 'MAX'; progress = 100; }
      else if (revenue > 50490000) { level = 'Lvl 4'; progress = 80; }
      else if (revenue > 33660000) { level = 'Lvl 3'; progress = 60; }
      else if (revenue > 16830000) { level = 'Lvl 2'; progress = 40; }

      return { amount: revenue * (percent / 100), percent, level, progress };
    }

    // --- DATA MANAGEMENT ---
    const loadData = () => {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]'); } catch { return []; }
    };
    const saveData = (data) => localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    
    const getTarget = () => {
      try { return JSON.parse(localStorage.getItem(TARGET_KEY)); } catch { return null; }
    };

    // --- UI RENDERER ---
    const els = {
      tbody: document.getElementById('tbody'),
      monthSel: document.getElementById('monthSelector'),
      search: document.getElementById('searchInput'),
      status: document.getElementById('statusFilter'),
      course: document.getElementById('courseFilter'),
      period: document.getElementById('periodFilter'),
      empty: document.getElementById('emptyState'),
      count: document.getElementById('recordCount')
    };

    let currentSort = { field: 'date', direction: 'desc' };
    let selectedRows = new Set();

    function renderTable() {
      const data = loadData();
      const month = els.monthSel.value;
      const q = els.search.value.toLowerCase().trim();
      
      let filtered = data.filter(r => {
        const rDate = new Date(r.date);
        const rMonth = `${rDate.getFullYear()}-${String(rDate.getMonth()+1).padStart(2,'0')}`;
        const rDay = rDate.getDate();
        const rPeriod = rDay <= 15 ? 'P1' : 'P2';

        if (month && rMonth !== month) return false;
        if (els.period.value && rPeriod !== els.period.value) return false;
        if (els.status.value && r.buyOrNot !== els.status.value) return false;
        if (els.course.value && r.course !== els.course.value) return false;
        if (q && !`${r.childName} ${r.note} ${r.course}`.toLowerCase().includes(q)) return false;
        return true;
      });

      // Sort
      filtered.sort((a, b) => {
        let valA = a[currentSort.field], valB = b[currentSort.field];
        if (currentSort.field === 'revenue') { valA = Number(valA)||0; valB = Number(valB)||0; }
        return currentSort.direction === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
      });

      // Update Stats
      updateStats(filtered, data);
      updateTarget(filtered);

      els.count.textContent = `${filtered.length} records`;
      els.tbody.innerHTML = '';

      if (filtered.length === 0) {
        els.empty.classList.remove('hidden');
        return;
      }
      els.empty.classList.add('hidden');

      filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = "group border-b border-white/5 hover:bg-white/[0.02] transition-colors";
        
        // Status Badge Style
        let badge = 'bg-slate-800 text-slate-400 border-slate-700';
        let icon = '‚Ä¢';
        if (r.buyOrNot === 'Buy') { badge = 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20'; icon = '‚úÖ'; }
        else if (r.buyOrNot === 'Not') { badge = 'bg-rose-500/10 text-rose-400 border-rose-500/20'; icon = '‚ùå'; }
        else if (r.buyOrNot === 'Pending') { badge = 'bg-amber-500/10 text-amber-400 border-amber-500/20'; icon = '‚è≥'; }

        // Course Style
        let courseStyle = 'text-slate-400';
        if (r.course && r.course.includes('Python')) courseStyle = 'text-blue-400';
        if (r.course && r.course.includes('Graphic')) courseStyle = 'text-pink-400';

        // Note Handling (Important Update)
        let noteHtml = '<span class="text-slate-600">-</span>';
        if (r.note) {
          noteHtml = `
            <div class="relative group/note cursor-help">
              <div class="max-w-[180px] truncate text-xs text-slate-400 flex items-center gap-1">
                ${r.note.length > 30 ? '<svg class="w-3 h-3 text-amber-500/70 shrink-0" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/></svg>' : ''}
                <span>${r.note}</span>
              </div>
              <!-- Tooltip on hover -->
              <div class="absolute bottom-full left-0 mb-2 hidden group-hover/note:block w-64 bg-dark-900 border border-white/20 p-3 rounded-lg shadow-xl z-50 text-xs text-white whitespace-normal break-words pointer-events-none">
                ${r.note}
                <div class="absolute -bottom-1 left-4 w-2 h-2 bg-dark-900 border-b border-r border-white/20 transform rotate-45"></div>
              </div>
            </div>
          `;
        }

        tr.innerHTML = `
          <td class="p-4 text-center"><input type="checkbox" class="row-cb rounded border-slate-600 bg-transparent text-amber-500 focus:ring-0 cursor-pointer" data-id="${r.id}" ${selectedRows.has(r.id) ? 'checked' : ''}></td>
          <td class="p-4">
            <div class="font-bold text-white text-xs">${r.date}</div>
            <div class="text-[10px] text-slate-500 font-mono">${r.time || ''}</div>
          </td>
          <td class="p-4">
            <div class="font-medium text-slate-200 text-sm">${r.childName || '-'}</div>
            ${r.crm ? `<a href="${r.crm}" target="_blank" class="text-[10px] text-indigo-400 hover:text-indigo-300 flex items-center gap-1 mt-0.5">üîó CRM Link</a>` : ''}
          </td>
          <td class="p-4">
            <span class="text-xs font-medium ${courseStyle}">${r.course || '-'}</span>
            ${r.layer ? `<span class="ml-1 text-[9px] bg-white/5 px-1 rounded text-slate-500">${r.layer}</span>` : ''}
          </td>
          <td class="p-4"><span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-md border text-[11px] font-bold ${badge}">${icon} ${r.buyOrNot}</span></td>
          <td class="p-4 font-mono text-emerald-400 font-bold text-xs">${formatRp(r.revenue)}</td>
          <td class="p-4">${noteHtml}</td>
          <td class="p-4 text-right sticky right-0 bg-dark-900 group-hover:bg-[#131a29] z-10 border-l border-white/5 shadow-[-5px_0_10px_rgba(0,0,0,0.2)]">
            <div class="flex justify-end gap-1">
              <button onclick="editRow('${r.id}')" class="p-1.5 text-blue-400 hover:bg-blue-500/20 rounded transition-colors" title="Edit">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
              </button>
              <button onclick="deleteRow('${r.id}')" class="p-1.5 text-rose-400 hover:bg-rose-500/20 rounded transition-colors" title="Delete">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              </button>
            </div>
          </td>
        `;
        els.tbody.appendChild(tr);
      });
      
      // Re-attach check listeners
      document.querySelectorAll('.row-cb').forEach(cb => {
        cb.addEventListener('change', e => {
          e.target.checked ? selectedRows.add(e.target.dataset.id) : selectedRows.delete(e.target.dataset.id);
          updateBulkBtn();
        });
      });
    }

    function updateStats(filtered, allData) {
      let tc=0, sales=0, rev=0, pending=0;
      filtered.forEach(r => {
        if(r.buyOrNot === 'Buy') { sales++; rev += Number(r.revenue)||0; tc++; }
        else if(r.buyOrNot === 'Not') tc++;
        else if(r.buyOrNot === 'Pending') { pending++; tc++; }
      });

      const conv = tc ? (sales/tc)*100 : 0;
      const bonus = calculateBonus(rev, conv);
      const tcSalary = tc * SALES_COMMISSION_USD * DOLLAR_RATE;

      document.getElementById('statRevenue').textContent = formatRp(rev);
      document.getElementById('statSales').textContent = sales;
      document.getElementById('statConversion').textContent = conv.toFixed(1) + '%';
      document.getElementById('statBonus').textContent = formatRp(bonus.amount);
      document.getElementById('bonusLevel').textContent = bonus.level;
      document.getElementById('bonusBar').style.width = bonus.progress + '%';
      
      document.getElementById('statTcTotal').textContent = tc;
      document.getElementById('statPending').textContent = pending;
      document.getElementById('statTcSalary').textContent = formatRp(tcSalary);
      document.getElementById('statAov').textContent = formatRp(sales ? rev/sales : 0);

      // Month Label
      const m = els.monthSel.value;
      if(m) {
         const [y, mo] = m.split('-');
         const date = new Date(y, mo-1);
         document.getElementById('selectedMonth').textContent = date.toLocaleString('en-US', { month: 'long', year: 'numeric' });
         document.getElementById('selectedPeriod').textContent = els.period.value || 'All';
      }
    }

    function updateTarget(filtered) {
      const m = els.monthSel.value;
      const target = getTarget();
      const div = document.getElementById('targetSection');

      if (!target || target.monthKey !== m) {
        div.classList.add('hidden');
        return;
      }
      
      div.classList.remove('hidden');
      const rev = filtered.reduce((acc, r) => r.buyOrNot === 'Buy' ? acc + (Number(r.revenue)||0) : acc, 0);
      const goal = Number(target.targetRevenue) || 1;
      const pct = Math.min((rev/goal)*100, 100);
      
      document.getElementById('targetDesc').textContent = formatRp(goal);
      document.getElementById('targetCurrent').textContent = formatRp(rev);
      document.getElementById('targetPercent').textContent = pct.toFixed(1) + '%';
      document.getElementById('targetProgress').style.width = pct + '%';
    }

    // --- FORM HANDLERS ---
    function editRow(id) {
      const r = loadData().find(x => x.id === id);
      if(!r) return;
      
      document.getElementById('editingId').value = r.id;
      document.getElementById('date').value = r.date;
      document.getElementById('time').value = r.time;
      document.getElementById('childName').value = r.childName;
      document.getElementById('crm').value = r.crm;
      document.getElementById('course').value = r.course;
      document.getElementById('buyOrNot').value = r.buyOrNot;
      document.getElementById('revenue').value = r.revenue;
      document.getElementById('layer').value = r.layer;
      document.getElementById('note').value = r.note;
      
      document.getElementById('formTitle').textContent = 'Edit Record';
      document.getElementById('formTitleIcon').className = "text-blue-400 bg-blue-400/10 p-1 rounded";
      document.getElementById('duplicateBtn').classList.remove('hidden');
      document.getElementById('duplicateBtn').onclick = () => duplicateRow(id);
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function deleteRow(id) {
      if(confirm('Delete this record?')) {
        const data = loadData().filter(r => r.id !== id);
        saveData(data);
        refresh();
        showToast('Deleted', 'Record removed', 'üóëÔ∏è');
      }
    }

    function duplicateRow(id) {
      const r = loadData().find(x => x.id === id);
      if(r) {
        const n = {...r, id: uid()};
        const data = loadData();
        data.push(n);
        saveData(data);
        refresh();
        showToast('Duplicated', 'Record copied', 'üìã');
      }
    }

    function updateBulkBtn() {
      const btn = document.getElementById('bulkDeleteBtn');
      if(selectedRows.size > 0) {
        btn.style.display = 'flex';
        document.getElementById('selectedCount').textContent = selectedRows.size;
      } else {
        btn.style.display = 'none';
      }
    }

    function refresh() {
      // Refresh Months
      const data = loadData();
      const months = new Set(data.map(r => {
         const d = new Date(r.date);
         return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      }));
      const curr = new Date();
      months.add(`${curr.getFullYear()}-${String(curr.getMonth()+1).padStart(2,'0')}`);
      
      const sorted = Array.from(months).sort().reverse();
      const oldVal = els.monthSel.value;
      
      els.monthSel.innerHTML = '';
      sorted.forEach(m => {
        const [y, mo] = m.split('-');
        const opt = document.createElement('option');
        opt.value = m;
        opt.textContent = new Date(y, mo-1).toLocaleString('en-US', { month: 'short', year: 'numeric' });
        els.monthSel.appendChild(opt);
      });
      
      if(oldVal && months.has(oldVal)) els.monthSel.value = oldVal;
      else els.monthSel.value = sorted[0];

      // Refresh Course Filter
      const courses = new Set([...COURSES, ...data.map(r=>r.course).filter(x=>x)]);
      const cOld = els.course.value;
      els.course.innerHTML = '<option value="">All Courses</option>';
      Array.from(courses).sort().forEach(c => {
        const opt = document.createElement('option');
        opt.value = c;
        opt.textContent = c;
        els.course.appendChild(opt);
      });
      els.course.value = cOld;

      renderTable();
    }

    // --- INITIALIZATION & EVENTS ---
    document.addEventListener('DOMContentLoaded', () => {
      refresh();

      // Form Submit
      document.getElementById('entryForm').addEventListener('submit', e => {
        e.preventDefault();
        const id = document.getElementById('editingId').value;
        const obj = {
          id: id || uid(),
          date: document.getElementById('date').value,
          time: document.getElementById('time').value,
          childName: document.getElementById('childName').value,
          crm: document.getElementById('crm').value,
          course: document.getElementById('course').value,
          buyOrNot: document.getElementById('buyOrNot').value,
          revenue: document.getElementById('revenue').value,
          layer: document.getElementById('layer').value,
          note: document.getElementById('note').value
        };

        let data = loadData();
        if(id) {
          const idx = data.findIndex(x => x.id === id);
          if(idx > -1) data[idx] = obj;
        } else {
          data.push(obj);
        }
        
        saveData(data);
        
        // Clear form
        document.getElementById('editingId').value = '';
        document.getElementById('formTitle').textContent = 'New Record';
        document.getElementById('formTitleIcon').className = "text-amber-400 bg-amber-400/10 p-1 rounded";
        document.getElementById('duplicateBtn').classList.add('hidden');
        document.getElementById('childName').value = '';
        document.getElementById('crm').value = '';
        document.getElementById('revenue').value = '';
        document.getElementById('note').value = '';
        
        refresh();
        showToast(id ? 'Updated' : 'Saved', 'Record successful');
      });

      document.getElementById('clearFormBtn').addEventListener('click', () => {
        document.getElementById('entryForm').reset();
        document.getElementById('editingId').value = '';
        document.getElementById('duplicateBtn').classList.add('hidden');
        document.getElementById('formTitle').textContent = 'New Record';
        document.getElementById('formTitleIcon').className = "text-amber-400 bg-amber-400/10 p-1 rounded";
      });

      // Filters Listeners
      ['monthSelector','periodFilter','statusFilter','courseFilter','searchInput'].forEach(id => {
        document.getElementById(id).addEventListener(id === 'searchInput' ? 'input' : 'change', renderTable);
      });

      document.getElementById('selectAll').addEventListener('change', e => {
        document.querySelectorAll('.row-cb').forEach(cb => {
          cb.checked = e.target.checked;
          e.target.checked ? selectedRows.add(cb.dataset.id) : selectedRows.delete(cb.dataset.id);
        });
        updateBulkBtn();
      });

      document.getElementById('bulkDeleteBtn').addEventListener('click', () => {
        if(confirm(`Delete ${selectedRows.size} records?`)) {
          const data = loadData().filter(r => !selectedRows.has(r.id));
          saveData(data);
          selectedRows.clear();
          document.getElementById('selectAll').checked = false;
          refresh();
          showToast('Bulk Deleted', 'Records removed');
        }
      });

      // Modals Logic
      const toggleModal = (id, show) => {
        const m = document.getElementById(id);
        const bg = document.getElementById('modalBackdrop');
        const content = m.querySelector('.modal-content');
        if(show) {
          m.classList.remove('hidden');
          bg.classList.remove('hidden');
          setTimeout(() => {
            bg.classList.remove('opacity-0');
            content.classList.remove('scale-95', 'opacity-0');
          }, 10);
        } else {
          bg.classList.add('opacity-0');
          content.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
            m.classList.add('hidden');
            bg.classList.add('hidden');
          }, 300);
        }
      };

      document.getElementById('menuBtn').addEventListener('click', (e) => {
         e.stopPropagation();
         document.getElementById('menu').classList.toggle('hidden');
      });
      document.addEventListener('click', () => document.getElementById('menu').classList.add('hidden'));

      document.getElementById('targetBtn').addEventListener('click', () => {
        toggleModal('targetModal', true);
        const t = getTarget();
        document.getElementById('targetInput').value = (t && t.monthKey === els.monthSel.value) ? t.targetRevenue : '';
      });
      document.getElementById('saveTargetBtn').addEventListener('click', () => {
        localStorage.setItem(TARGET_KEY, JSON.stringify({ monthKey: els.monthSel.value, targetRevenue: document.getElementById('targetInput').value }));
        toggleModal('targetModal', false);
        refresh();
        showToast('Target Set');
      });
      document.getElementById('cancelTargetBtn').addEventListener('click', () => toggleModal('targetModal', false));

      // Export
      const exportCSV = () => {
        const data = loadData().filter(r => {
           const d = new Date(r.date);
           return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}` === els.monthSel.value;
        });
        if(!data.length) return showToast('No Data', 'Nothing to export', '‚ö†Ô∏è');
        
        const header = ['Date','Time','Student','Course','Status','Revenue','Note','CRM'];
        const rows = data.map(r => [r.date, r.time, r.childName, r.course, r.buyOrNot, r.revenue, r.note, r.crm].map(f => `"${String(f||'').replace(/"/g,'""')}"`).join(','));
        const csv = [header.join(','), ...rows].join('\n');
        const blob = new Blob([csv], {type: 'text/csv'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `sales_${els.monthSel.value}.csv`;
        a.click();
      };
      document.getElementById('exportCurrentBtn').addEventListener('click', exportCSV);

      // Chart
      document.getElementById('chartBtn').addEventListener('click', () => {
        toggleModal('chartModal', true);
        const data = loadData().filter(r => r.date.startsWith(els.monthSel.value));
        const counts = { Buy:0, Not:0, Pending:0 };
        const courses = {};
        data.forEach(r => {
          counts[r.buyOrNot]++;
          courses[r.course] = (courses[r.course]||0)+1;
        });
        
        const max = Math.max(counts.Buy, counts.Not, counts.Pending, 1);
        document.getElementById('statusChart').innerHTML = `
          <div class="w-16 bg-emerald-500/20 hover:bg-emerald-500/30 rounded-t-lg relative group transition-all h-full" style="height:${(counts.Buy/max)*100}%">
             <span class="absolute -top-6 left-0 w-full text-center text-emerald-400 font-bold">${counts.Buy}</span>
             <span class="absolute bottom-2 left-0 w-full text-center text-[10px] uppercase">Buy</span>
          </div>
          <div class="w-16 bg-rose-500/20 hover:bg-rose-500/30 rounded-t-lg relative group transition-all h-full" style="height:${(counts.Not/max)*100}%">
             <span class="absolute -top-6 left-0 w-full text-center text-rose-400 font-bold">${counts.Not}</span>
             <span class="absolute bottom-2 left-0 w-full text-center text-[10px] uppercase">Not</span>
          </div>
          <div class="w-16 bg-amber-500/20 hover:bg-amber-500/30 rounded-t-lg relative group transition-all h-full" style="height:${(counts.Pending/max)*100}%">
             <span class="absolute -top-6 left-0 w-full text-center text-amber-400 font-bold">${counts.Pending}</span>
             <span class="absolute bottom-2 left-0 w-full text-center text-[10px] uppercase">Wait</span>
          </div>
        `;

        document.getElementById('courseBreakdown').innerHTML = Object.entries(courses).sort((a,b)=>b[1]-a[1]).map(([k,v]) => `
          <div class="flex items-center justify-between text-xs">
            <span class="text-slate-400 truncate w-32">${k}</span>
            <div class="flex-1 mx-2 h-1.5 bg-dark-900 rounded-full overflow-hidden"><div class="h-full bg-indigo-500" style="width:${(v/data.length)*100}%"></div></div>
            <span class="text-white font-bold w-6 text-right">${v}</span>
          </div>
        `).join('');
      });
      document.getElementById('closeChartBtn').addEventListener('click', () => toggleModal('chartModal', false));
      
      // Reset
      document.getElementById('resetBtn').addEventListener('click', () => toggleModal('pwModal', true));
      document.getElementById('cancelPwBtn').addEventListener('click', () => toggleModal('pwModal', false));
      document.getElementById('confirmPwBtn').addEventListener('click', () => {
         if(document.getElementById('pwInput').value === RESET_PASSWORD) {
           localStorage.clear();
           location.reload();
         } else showToast('Error', 'Wrong Password', '‚ùå');
      });

      // Import
      document.getElementById('importBtn').addEventListener('click', () => toggleModal('importModal', true));
      document.getElementById('cancelImportBtn').addEventListener('click', () => toggleModal('importModal', false));
      document.getElementById('confirmImportBtn').addEventListener('click', () => {
        const f = document.getElementById('importFile').files[0];
        if(f) {
          const reader = new FileReader();
          reader.onload = e => {
             const rows = e.target.result.split('\n').slice(1).filter(x=>x.trim());
             const newData = rows.map(r => {
               const c = r.split(/,(?=(?:(?:[^"]*"){2})*[^"]*$)/).map(x => x.replace(/^"|"$/g, '').replace(/""/g, '"'));
               return { id: uid(), date:c[0], time:c[1], childName:c[2], course:c[3], buyOrNot:c[4], revenue:c[5], note:c[6], crm:c[7] };
             });
             const current = loadData();
             saveData([...current, ...newData]);
             refresh();
             toggleModal('importModal', false);
             showToast('Imported', `${newData.length} records added`);
          };
          reader.readAsText(f);
        }
      });
    });
  </script>
</body>
</html>
```

