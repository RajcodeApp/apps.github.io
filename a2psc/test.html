
<!DOCTYPE html>
<html lang="id" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mi Raj Sales Tracker Pro</title>
  <meta name="theme-color" content="#0f172a">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          fontFamily: {
            sans: ['"Plus Jakarta Sans"', 'sans-serif'],
          },
          colors: {
            dark: {
              900: '#0B0F19',
              800: '#111827',
              700: '#1F2937',
            },
            accent: {
              gold: '#FBBF24',
              goldDim: '#B45309',
            }
          },
          animation: {
            'blob': 'blob 7s infinite',
            'fade-in': 'fadeIn 0.3s ease-out',
            'shimmer': 'shimmer 2s linear infinite',
          },
          keyframes: {
            blob: {
              '0%': { transform: 'translate(0px, 0px) scale(1)' },
              '33%': { transform: 'translate(30px, -50px) scale(1.1)' },
              '66%': { transform: 'translate(-20px, 20px) scale(0.9)' },
              '100%': { transform: 'translate(0px, 0px) scale(1)' },
            },
            fadeIn: {
              '0%': { opacity: '0', transform: 'translateY(10px)' },
              '100%': { opacity: '1', transform: 'translateY(0)' },
            },
            shimmer: {
              '0%': { backgroundPosition: '-200% 0' },
              '100%': { backgroundPosition: '200% 0' }
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #4B5563; }

    /* Background Mesh */
    .mesh-bg {
      background-color: #0B0F19;
      background-image: 
        radial-gradient(at 0% 0%, rgba(99, 102, 241, 0.12) 0px, transparent 50%),
        radial-gradient(at 100% 0%, rgba(236, 72, 153, 0.12) 0px, transparent 50%),
        radial-gradient(at 100% 100%, rgba(16, 185, 129, 0.08) 0px, transparent 50%),
        radial-gradient(at 0% 100%, rgba(251, 191, 36, 0.08) 0px, transparent 50%);
      min-height: 100vh;
    }

    /* Glass Components */
    .glass-panel {
      background: rgba(17, 24, 39, 0.7);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.08);
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
    }
    .glass-panel:hover {
      border-color: rgba(255, 255, 255, 0.12);
    }

    .input-field {
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.1);
      transition: all 0.3s ease;
    }
    .input-field:focus {
      background: rgba(0, 0, 0, 0.5);
      border-color: #FBBF24;
      box-shadow: 0 0 0 2px rgba(251, 191, 36, 0.2);
      outline: none;
    }

    /* Loader */
    .loading-bar {
      height: 3px;
      width: 100%;
      background: linear-gradient(90deg, transparent, #FBBF24, transparent);
      background-size: 200% 100%;
      animation: loading 1.5s infinite;
      display: none;
    }
    @keyframes loading {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }

    /* Table zebra striping */
    .table-zebra tbody tr:nth-child(odd) {
      background: rgba(255, 255, 255, 0.02);
    }

    /* Small pill buttons */
    .pill-btn {
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.04);
    }
    .pill-btn:hover {
      border-color: rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.08);
    }

    /* Soft shadow for sticky header */
    .sticky-shadow {
      box-shadow: 0 8px 20px -10px rgba(0,0,0,0.5);
    }
  </style>
</head>
<body class="mesh-bg text-slate-300 font-sans antialiased selection:bg-accent-gold selection:text-black">

  <!-- Toast Notification -->
  <div id="toast" class="fixed bottom-6 right-6 z-50 hidden transform transition-all duration-300 translate-y-10 opacity-0">
    <div class="glass-panel rounded-xl p-4 flex items-center gap-3 shadow-2xl border-l-4 border-emerald-500">
      <div class="bg-emerald-500/20 p-2 rounded-full text-emerald-400">
        <span id="toastIcon" class="text-lg"></span>
      </div>
      <div>
        <h4 id="toastTitle" class="text-sm font-bold text-white">Success</h4>
        <p id="toastMessage" class="text-xs text-slate-400">Action completed.</p>
      </div>
    </div>
  </div>

  <!-- Navbar -->
  <nav class="sticky top-0 z-40 border-b border-white/5 bg-[#0B0F19]/80 backdrop-blur-xl">
    <div class="loading-bar" id="topLoader"></div>
    <div class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between h-16">
        <!-- Logo -->
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-400 to-orange-600 flex items-center justify-center shadow-lg shadow-orange-500/20 text-black font-bold text-xl tracking-tighter">MR</div>
          <div>
            <h1 class="text-white font-bold text-lg tracking-tight leading-none">Mi Raj <span class="text-amber-400 font-light">Tracker</span></h1>
            <p class="text-[10px] text-slate-500 font-medium uppercase tracking-widest">Sales Intelligence Pro</p>
          </div>
        </div>

        <!-- Top Actions -->
        <div class="flex items-center gap-3">
          <button id="shortcutsBtn" class="p-2 rounded-lg hover:bg-white/5 text-slate-400 hover:text-white transition-colors" title="Shortcuts">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
          </button>
          
          <div class="relative">
            <button id="menuBtn" class="flex items-center gap-2 px-3 py-2 rounded-lg pill-btn text-sm font-medium text-white transition-all">
              <span>Menu</span>
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
            </button>
            
            <!-- Dropdown -->
            <div id="menu" class="absolute right-0 mt-2 w-48 glass-panel rounded-xl shadow-2xl py-1 hidden transform origin-top-right transition-all z-50">
              <button id="importBtn" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-white/5 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg> Import CSV
              </button>
              <button id="exportAllBtn" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-white/5 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg> Export All
              </button>
              <button id="targetBtn" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-white/5 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg> Set Target
              </button>
              <button id="chartBtn" class="w-full text-left px-4 py-2 text-sm text-slate-300 hover:bg-white/5 hover:text-white flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z"></path></svg> Analytics
              </button>
              <div class="h-px bg-white/10 my-1"></div>
              <button id="resetBtn" class="w-full text-left px-4 py-2 text-sm text-rose-500 hover:bg-rose-500/10 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg> Reset Data
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <main class="max-w-[1600px] mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Target Progress (Conditional) -->
    <div id="targetSection" class="hidden mb-8 animate-fade-in">
      <div class="glass-panel rounded-2xl p-1 relative overflow-hidden group">
        <div class="absolute top-0 left-0 w-full h-full bg-gradient-to-r from-amber-500/10 via-transparent to-emerald-500/10 opacity-50"></div>
        <div class="bg-dark-800/50 rounded-xl p-5 relative z-10">
          <div class="flex items-end justify-between mb-3">
            <div>
              <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-wider">Monthly Goal</h3>
              <div class="flex items-baseline gap-3 mt-1">
                <span id="targetCurrent" class="text-2xl font-bold text-white">Rp 0</span>
                <span class="text-sm text-slate-500">of <span id="targetDesc" class="text-slate-400">Rp 0</span></span>
              </div>
            </div>
            <div class="text-right">
              <span id="targetPercent" class="text-4xl font-black text-transparent bg-clip-text bg-gradient-to-r from-amber-400 to-orange-500">0%</span>
              <button id="editTargetBtn" class="block ml-auto mt-1 text-xs text-slate-500 hover:text-amber-400 underline decoration-dotted">Change</button>
            </div>
          </div>
          <div class="h-4 bg-dark-900 rounded-full overflow-hidden border border-white/5 relative">
            <div id="targetProgress" class="h-full bg-gradient-to-r from-amber-400 to-orange-600 rounded-full transition-all duration-1000 ease-out shadow-[0_0_20px_rgba(245,158,11,0.5)] relative" style="width: 0%">
              <div class="absolute inset-0 [background:linear-gradient(90deg,transparent,rgba(255,255,255,0.6),transparent)] bg-[length:200%_100%] animate-shimmer"></div>
            </div>
          </div>
          <div class="flex justify-between mt-3 text-xs font-medium">
            <span class="text-slate-500">Remaining: <span id="targetRemaining" class="text-emerald-400">Rp 0</span></span>
            <span class="text-amber-500">Keep Pushing! üöÄ</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Stats Grid -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-8">
      <div class="glass-panel rounded-2xl p-5 relative overflow-hidden group hover:border-emerald-500/30 transition-all duration-300">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-emerald-500/20 rounded-full blur-2xl group-hover:bg-emerald-500/30 transition-all"></div>
        <div class="relative z-10">
          <p class="text-xs font-semibold text-emerald-400 uppercase tracking-wider mb-1">Total Revenue</p>
          <h3 id="statRevenue" class="text-2xl xl:text-3xl font-bold text-white tracking-tight">Rp 0</h3>
          <p id="statRevChange" class="text-xs mt-2 font-medium text-slate-500 flex items-center gap-1">
            <span>-</span> vs prev month
          </p>
        </div>
      </div>

      <div class="glass-panel rounded-2xl p-5 relative overflow-hidden group hover:border-blue-500/30 transition-all duration-300">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-blue-500/20 rounded-full blur-2xl group-hover:bg-blue-500/30 transition-all"></div>
        <div class="grid grid-cols-2 gap-4 relative z-10 h-full">
          <div>
            <p class="text-[10px] font-semibold text-blue-400 uppercase tracking-wider mb-1">Sales</p>
            <h3 id="statSales" class="text-2xl font-bold text-white">0</h3>
            <p id="statSalesChange" class="text-[10px] text-slate-500 mt-1">-</p>
          </div>
          <div class="text-right border-l border-white/10 pl-4">
             <p class="text-[10px] font-semibold text-indigo-400 uppercase tracking-wider mb-1">Conv.</p>
             <h3 id="statConversion" class="text-xl font-bold text-white">0%</h3>
             <p id="statConvChange" class="text-[10px] text-slate-500 mt-1">0/0</p>
          </div>
        </div>
      </div>

      <div class="glass-panel rounded-2xl p-5 relative overflow-hidden group hover:border-pink-500/30 transition-all duration-300">
        <div class="absolute -right-6 -top-6 w-24 h-24 bg-pink-500/20 rounded-full blur-2xl group-hover:bg-pink-500/30 transition-all"></div>
        <div class="relative z-10">
          <div class="flex justify-between items-start">
            <div>
              <p class="text-xs font-semibold text-pink-400 uppercase tracking-wider mb-1">Est. Bonus</p>
              <h3 id="statBonus" class="text-2xl font-bold text-white">Rp 0</h3>
            </div>
            <span id="bonusLevel" class="bg-slate-700/50 text-slate-300 text-[10px] px-2 py-1 rounded-md font-bold border border-white/10">Lvl 1</span>
          </div>
          <div class="w-full bg-dark-900/50 h-1.5 rounded-full mt-4 overflow-hidden">
            <div id="bonusBar" class="h-full bg-pink-500 w-0 transition-all duration-500"></div>
          </div>
          <p class="text-[10px] text-slate-500 mt-2 flex justify-between">
            <span>Rate: <span id="bonusPercent" class="text-slate-300">0%</span></span>
            <span>TC Salary: <span id="statTcSalary" class="text-cyan-400">Rp 0</span></span>
          </p>
        </div>
      </div>

      <div class="glass-panel rounded-2xl p-5 relative overflow-hidden flex flex-col justify-between">
        <div class="flex justify-between items-center">
          <div>
            <p class="text-[10px] text-slate-500 font-bold uppercase">Total TC</p>
            <p id="statTcTotal" class="text-lg font-bold text-white">0</p>
          </div>
           <div class="text-right">
            <p class="text-[10px] text-slate-500 font-bold uppercase">Pending</p>
            <p id="statPending" class="text-lg font-bold text-amber-400">0</p>
          </div>
        </div>
        <div class="mt-2 pt-2 border-t border-white/5 flex justify-between items-center">
          <span class="text-[10px] text-slate-500">AOV</span>
          <span id="statAov" class="text-xs font-mono text-purple-400">Rp 0</span>
        </div>
      </div>
    </div>

    <!-- Workspace Area (Filter + Form + Table) -->
    <div class="grid lg:grid-cols-4 gap-6 h-full">
      
      <!-- Left Panel: Filters & Form -->
      <div class="lg:col-span-1 flex flex-col gap-6">
        
        <!-- Filters -->
        <div class="glass-panel rounded-2xl p-5">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-white flex items-center gap-2">
              <svg class="w-4 h-4 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z"></path></svg>
              Filters
            </h3>
            <button id="refreshBtn" class="text-slate-500 hover:text-amber-400 transition-colors p-1" title="Refresh">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            </button>
          </div>

          <div class="space-y-3">
            <div class="relative">
              <svg class="w-4 h-4 absolute left-3 top-3 text-slate-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
              <input id="searchInput" type="text" placeholder="Search name, course, notes..." class="w-full bg-dark-900/50 border border-white/10 rounded-lg pl-9 pr-3 py-2 text-sm text-white placeholder-slate-600 focus:ring-1 focus:ring-amber-500 focus:border-amber-500 outline-none transition-all">
            </div>

            <div class="grid grid-cols-2 gap-2">
              <select id="monthSelector" class="bg-dark-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-slate-300 focus:border-amber-500 outline-none"></select>
              <select id="periodFilter" class="bg-dark-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-slate-300 focus:border-amber-500 outline-none">
                <option value="">All Period</option>
                <option value="P1">P1 (1-15)</option>
                <option value="P2">P2 (16-31)</option>
              </select>
            </div>

            <select id="statusFilter" class="w-full bg-dark-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-slate-300 focus:border-amber-500 outline-none">
              <option value="">All Statuses</option>
              <option value="Buy">‚úÖ Buy</option>
              <option value="Not">‚ùå Not Buy</option>
              <option value="Pending">‚è≥ Pending</option>
            </select>
            
             <select id="courseFilter" class="w-full bg-dark-900/50 border border-white/10 rounded-lg px-3 py-2 text-xs text-slate-300 focus:border-amber-500 outline-none">
              <option value="">All Courses</option>
            </select>

            <div class="pt-2 border-t border-white/5 flex justify-between items-center">
               <span id="recordCount" class="text-[10px] text-slate-500 font-mono">0 records</span>
               <button id="exportCurrentBtn" class="text-[10px] text-amber-500 hover:text-amber-400 font-medium">Export CSV</button>
            </div>
          </div>
        </div>

        <!-- Entry Form -->
        <div class="glass-panel rounded-2xl p-5 flex-1">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-bold text-white flex items-center gap-2">
              <span id="formTitleIcon" class="text-amber-400">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
              </span>
              <span id="formTitle">New Record</span>
            </h3>
            <button id="clearFormBtn" class="text-xs text-slate-500 hover:text-white transition-colors">Clear</button>
          </div>

          <form id="entryForm" class="space-y-3">
            <input type="hidden" id="editingId">
            
            <div class="grid grid-cols-2 gap-2">
               <div class="space-y-1">
                 <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Date</label>
                 <input id="date" type="date" required class="w-full input-field rounded-lg px-3 py-2 text-xs text-white">
               </div>
               <div class="space-y-1">
                 <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Time</label>
                 <input id="time" type="time" class="w-full input-field rounded-lg px-3 py-2 text-xs text-white">
               </div>
            </div>

            <div class="space-y-1">
               <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Student Name</label>
               <input id="childName" type="text" placeholder="Full Name" class="w-full input-field rounded-lg px-3 py-2 text-sm text-white placeholder-slate-600">
            </div>

             <div class="space-y-1">
               <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">CRM Link</label>
               <input id="crm" type="url" placeholder="https://..." class="w-full input-field rounded-lg px-3 py-2 text-xs text-blue-400 placeholder-slate-700">
            </div>

            <div class="grid grid-cols-2 gap-2">
               <div class="space-y-1">
                 <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Course</label>
                 <select id="course" required class="w-full input-field rounded-lg px-2 py-2 text-xs text-white">
                   <option value="">Select...</option>
                    <option value="Coding Knight">Coding Knight</option>
                    <option value="Digital Literasi">Digital Literasi</option>
                    <option value="Visual Programming">Visual Programming</option>
                    <option value="Graphic Design Junior">Graphic Design Junior</option>
                    <option value="Graphic Design Senior">Graphic Design Senior</option>
                    <option value="Game Design">Game Design</option>
                    <option value="Python Start">Python Start</option>
                    <option value="Python Pro">Python Pro</option>
                    <option value="Math Explorers">Math Explorers</option>
                    <option value="Math Masters">Math Masters</option>
                    <option value="Course AI">Course AI</option>
                    <option value="Math Tutoring">Math Tutoring</option>
                 </select>
               </div>
               <div class="space-y-1">
                 <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Status</label>
                 <select id="buyOrNot" required class="w-full input-field rounded-lg px-2 py-2 text-xs text-white">
                   <option value="">Select...</option>
                   <option value="Buy">‚úÖ Buy</option>
                   <option value="Not">‚ùå Not Buy</option>
                   <option value="Pending">‚è≥ Pending</option>
                 </select>
               </div>
            </div>

            <div class="grid grid-cols-2 gap-2">
              <div class="space-y-1">
                 <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Revenue</label>
                 <input id="revenue" type="number" placeholder="0" class="w-full input-field rounded-lg px-3 py-2 text-xs text-emerald-400 font-mono placeholder-slate-700">
               </div>
               <div class="space-y-1">
                 <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Layer</label>
                 <select id="layer" class="w-full input-field rounded-lg px-2 py-2 text-xs text-white">
                   <option value="">-</option>
                   <option value="TCP">TCP</option>
                   <option value="ND">ND</option>
                   <option value="PP">PP</option>
                   <option value="Other">Other</option>
                 </select>
               </div>
            </div>

            <div class="space-y-1">
               <label class="text-[10px] uppercase text-slate-500 font-bold tracking-wider">Note</label>
               <textarea id="note" rows="2" placeholder="Additional info..." class="w-full input-field rounded-lg px-3 py-2 text-xs text-white placeholder-slate-600 resize-none"></textarea>
            </div>

             <!-- Hidden Fields for advanced logic if needed -->
             <input id="paymentDate" type="date" class="hidden">

            <div class="pt-2 flex gap-2">
              <button type="submit" class="flex-1 bg-gradient-to-r from-amber-500 to-orange-600 hover:from-amber-400 hover:to-orange-500 text-black font-bold py-2.5 rounded-lg shadow-lg shadow-orange-500/20 transition-all transform hover:-translate-y-0.5 active:translate-y-0 text-sm">
                Save Record
              </button>
              <button type="button" id="duplicateBtn" class="hidden px-3 bg-slate-700 hover:bg-slate-600 text-white rounded-lg transition-colors" title="Duplicate">
                 <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
              </button>
            </div>
          </form>
        </div>

      </div>

      <!-- Right Panel: Table -->
      <div class="lg:col-span-3 flex flex-col h-full">
        <div class="glass-panel rounded-2xl flex-1 flex flex-col overflow-hidden">
          <!-- Table Header Actions -->
          <div class="p-4 border-b border-white/5 flex justify-between items-center bg-dark-800/30 sticky top-0 z-20 sticky-shadow">
            <div class="flex items-center gap-2">
              <span id="selectedMonth" class="text-sm font-bold text-amber-400"></span>
              <span id="selectedPeriod" class="text-xs font-medium text-slate-500 bg-white/5 px-2 py-0.5 rounded"></span>
            </div>
            <button id="bulkDeleteBtn" class="hidden items-center gap-1 px-3 py-1 bg-rose-500/10 text-rose-500 border border-rose-500/20 hover:bg-rose-500/20 rounded text-xs font-bold transition-all">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
              Delete (<span id="selectedCount">0</span>)
            </button>
          </div>

          <!-- Actual Table -->
          <div class="overflow-auto flex-1 relative">
            <!-- Empty State -->
            <div id="emptyState" class="hidden absolute inset-0 flex flex-col items-center justify-center text-center p-8 z-10">
              <div class="w-16 h-16 bg-slate-800/50 rounded-full flex items-center justify-center mb-4">
                <svg class="w-8 h-8 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
              </div>
              <h3 class="text-slate-300 font-bold mb-1">No Data Found</h3>
              <p class="text-slate-500 text-sm">Try adjusting filters or add a new record.</p>
            </div>

            <table class="w-full text-left border-collapse table-zebra">
              <thead class="bg-dark-900/50 text-xs text-slate-500 uppercase sticky top-12 z-10 backdrop-blur-md">
                <tr>
                  <th class="p-4 w-10"><input type="checkbox" id="selectAll" class="rounded border-slate-600 bg-transparent focus:ring-amber-500 text-amber-500"></th>
                  <th class="p-4 font-semibold cursor-pointer hover:text-amber-400 transition-colors" data-sort="date">Date ‚Üï</th>
                  <th class="p-4 font-semibold">Student</th>
                  <th class="p-4 font-semibold">Course</th>
                  <th class="p-4 font-semibold">Notes</th>
                  <th class="p-4 font-semibold cursor-pointer hover:text-amber-400 transition-colors" data-sort="buyOrNot">Status ‚Üï</th>
                  <th class="p-4 font-semibold cursor-pointer hover:text-amber-400 transition-colors" data-sort="revenue">Revenue ‚Üï</th>
                  <th class="p-4 text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="tbody" class="text-sm text-slate-300 divide-y divide-white/5">
                <!-- Rows will be injected here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- MODALS (Hidden by default) -->
  
  <!-- Overlay Backdrop -->
  <div id="modalBackdrop" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden transition-opacity"></div>

  <!-- Chart Modal -->
  <div id="chartModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-4xl bg-[#0F172A] border border-white/10 rounded-2xl shadow-2xl flex flex-col max-h-[90vh]">
      <div class="p-5 border-b border-white/5 flex justify-between items-center">
        <h3 class="text-lg font-bold text-white">Analytics Dashboard</h3>
        <button id="closeChartBtn" class="text-slate-500 hover:text-white">‚úï</button>
      </div>
      <div class="p-6 overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6">
         <div class="glass-panel p-4 rounded-xl">
           <h4 class="text-xs font-bold text-slate-500 uppercase mb-4">Status Distribution</h4>
           <div id="statusChart" class="h-40"></div>
         </div>
         <div class="glass-panel p-4 rounded-xl">
           <h4 class="text-xs font-bold text-slate-500 uppercase mb-4">Monthly Trend (Conv %)</h4>
           <div id="trendChart" class="h-40 space-y-2"></div>
         </div>
         <div class="glass-panel p-4 rounded-xl md:col-span-2">
           <h4 class="text-xs font-bold text-slate-500 uppercase mb-4">Course Popularity</h4>
           <div id="courseBreakdown" class="grid grid-cols-1 sm:grid-cols-2 gap-x-8 gap-y-2"></div>
         </div>
      </div>
    </div>
  </div>

  <!-- Target Modal -->
  <div id="targetModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-md bg-[#0F172A] border border-amber-500/30 rounded-2xl shadow-2xl p-6">
       <h3 class="text-lg font-bold text-white mb-4">üéØ Set Monthly Target</h3>
       <label class="block text-xs text-slate-500 mb-2">Revenue Target (IDR)</label>
       <input id="targetInput" type="number" class="w-full bg-dark-900 border border-white/10 rounded-lg p-3 text-xl font-bold text-white focus:border-amber-500 outline-none mb-6" placeholder="50000000">
       <div class="flex justify-end gap-3">
         <button id="cancelTargetBtn" class="px-4 py-2 text-slate-400 hover:text-white text-sm">Cancel</button>
         <button id="saveTargetBtn" class="px-4 py-2 bg-amber-500 hover:bg-amber-400 text-black font-bold rounded-lg text-sm">Save Target</button>
       </div>
    </div>
  </div>

  <!-- Password Modal (Reset) -->
  <div id="pwModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-sm bg-[#0F172A] border border-rose-500/30 rounded-2xl shadow-2xl p-6">
      <div class="flex items-center gap-3 mb-4 text-rose-500">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
        <h3 class="text-lg font-bold text-white">Factory Reset</h3>
      </div>
       <p class="text-sm text-slate-400 mb-4">This will permanently delete ALL data. Enter password to confirm.</p>
       <input id="pwInput" type="password" class="w-full bg-dark-900 border border-white/10 rounded-lg p-3 text-white focus:border-rose-500 outline-none mb-6" placeholder="Password...">
       <div class="flex justify-end gap-3">
         <button id="cancelPwBtn" class="px-4 py-2 text-slate-400 hover:text-white text-sm">Cancel</button>
         <button id="confirmPwBtn" class="px-4 py-2 bg-rose-600 hover:bg-rose-500 text-white font-bold rounded-lg text-sm">NUKE IT üí•</button>
       </div>
    </div>
  </div>

  <!-- Import Modal -->
  <div id="importModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-md bg-[#0F172A] border border-white/10 rounded-2xl shadow-2xl p-6">
       <h3 class="text-lg font-bold text-white mb-2">üì• Import CSV</h3>
       <p class="text-xs text-slate-400 mb-4">Upload a standard CSV file generated by this app.</p>
       <div class="border-2 border-dashed border-white/10 rounded-xl p-8 text-center hover:border-amber-500/50 transition-colors cursor-pointer relative">
         <input type="file" id="importFile" accept=".csv" class="absolute inset-0 opacity-0 cursor-pointer w-full h-full">
         <svg class="w-8 h-8 mx-auto text-slate-500 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
         <span class="text-sm text-amber-500 font-medium">Click to upload</span>
       </div>
       <div class="flex justify-end gap-3 mt-6">
         <button id="cancelImportBtn" class="px-4 py-2 text-slate-400 hover:text-white text-sm">Cancel</button>
         <button id="confirmImportBtn" class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white font-bold rounded-lg text-sm">Process Import</button>
       </div>
    </div>
  </div>

  <!-- Shortcuts Modal -->
  <div id="shortcutsModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-2xl bg-[#0F172A]/95 backdrop-blur border border-white/10 rounded-2xl shadow-2xl p-6">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-white">Keyboard Shortcuts</h3>
        <button id="closeShortcutsBtn" class="text-slate-500 hover:text-white">‚úï</button>
      </div>
      <div class="grid grid-cols-2 gap-6">
        <div class="space-y-3">
           <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
             <span class="text-sm text-slate-300">New Record</span>
             <kbd class="bg-dark-900 px-2 py-1 rounded text-xs text-amber-500 font-mono border border-white/10">Ctrl + N</kbd>
           </div>
           <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
             <span class="text-sm text-slate-300">Search</span>
             <kbd class="bg-dark-900 px-2 py-1 rounded text-xs text-amber-500 font-mono border border-white/10">Ctrl + K</kbd>
           </div>
           <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
             <span class="text-sm text-slate-300">Export CSV</span>
             <kbd class="bg-dark-900 px-2 py-1 rounded text-xs text-amber-500 font-mono border border-white/10">Ctrl + E</kbd>
           </div>
        </div>
        <div class="space-y-3">
           <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
             <span class="text-sm text-slate-300">Refresh Data</span>
             <kbd class="bg-dark-900 px-2 py-1 rounded text-xs text-amber-500 font-mono border border-white/10">Ctrl + R</kbd>
           </div>
           <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
             <span class="text-sm text-slate-300">Open Analytics</span>
             <kbd class="bg-dark-900 px-2 py-1 rounded text-xs text-amber-500 font-mono border border-white/10">Ctrl + G</kbd>
           </div>
           <div class="flex justify-between items-center bg-white/5 p-3 rounded-lg">
             <span class="text-sm text-slate-300">Close Modals</span>
             <kbd class="bg-dark-900 px-2 py-1 rounded text-xs text-slate-400 font-mono border border-white/10">Esc</kbd>
           </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Note Modal -->
  <div id="noteModal" class="fixed inset-0 z-50 hidden flex items-center justify-center p-4 pointer-events-none">
    <div class="pointer-events-auto w-full max-w-lg bg-[#0F172A] border border-white/10 rounded-2xl shadow-2xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-bold text-white">üìù Note</h3>
        <button id="closeNoteBtn" class="text-slate-500 hover:text-white">‚úï</button>
      </div>
      <div id="noteContent" class="bg-dark-900/60 border border-white/10 rounded-xl p-4 text-slate-200 text-sm leading-relaxed whitespace-pre-wrap max-h-80 overflow-auto"></div>
      <div class="flex justify-end gap-3 mt-6">
        <button id="copyNoteBtn" class="px-4 py-2 pill-btn rounded-lg text-sm">Copy</button>
        <button id="closeNoteBtn2" class="px-4 py-2 bg-amber-500 hover:bg-amber-400 text-black font-bold rounded-lg text-sm">Close</button>
      </div>
    </div>
  </div>

  <!-- MAIN LOGIC SCRIPT -->
  <script>
    // --- KONFIGURASI & UTILS ---
    const STORAGE_KEY = 'mrj_sales_data';
    const TARGET_KEY = 'mrj_target';
    const RESET_PASSWORD = 'resetozeromrj';
    const DOLLAR_RATE = 16000;
    const SALES_COMMISSION_USD = 2.5;

    const COURSES = [
      'Coding Knight', 'Digital Literasi', 'Visual Programming',
      'Graphic Design Junior', 'Graphic Design Senior', 'Game Design',
      'Python Start', 'Python Pro', 'Math Explorers', 'Math Masters',
      'Course AI', 'Math Tutoring'
    ];

    function uid() { return 'id-' + Date.now() + '-' + Math.random().toString(36).slice(2, 9); }

    function showToast(title, message = '', icon = '‚úÖ', ms = 3000) {
      const toast = document.getElementById('toast');
      const toastTitle = document.getElementById('toastTitle');
      const toastMessage = document.getElementById('toastMessage');
      const toastIcon = document.getElementById('toastIcon');
      
      toastTitle.textContent = title;
      toastMessage.textContent = message;
      toastIcon.textContent = icon;
      
      toast.classList.remove('hidden');
      // Animation in
      setTimeout(() => {
        toast.classList.remove('translate-y-10', 'opacity-0');
      }, 10);

      clearTimeout(toast._timer);
      toast._timer = setTimeout(() => {
        toast.classList.add('translate-y-10', 'opacity-0');
        setTimeout(() => toast.classList.add('hidden'), 300);
      }, ms);
    }

    function formatRp(num) {
      if (num === null || num === undefined || num === '') return 'Rp 0';
      const n = Number(num) || 0;
      return new Intl.NumberFormat('id-ID', { 
        style: 'currency', 
        currency: 'IDR', 
        maximumFractionDigits: 0 
      }).format(n);
    }

    function monthKeyFromDateStr(dateStr) {
      if (!dateStr) {
        const d = new Date();
        return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
      }
      return dateStr.slice(0,7);
    }

    function getPeriodFromDate(dateStr) {
      if (!dateStr) return '';
      const day = parseInt(dateStr.split('-')[2]);
      return day <= 15 ? 'P1' : 'P2';
    }

    function truncate(str, n) {
      const s = String(str || '');
      return s.length <= n ? s : s.slice(0, n).trim() + '‚Ä¶';
    }

    function escapeHtml(str) {
      return String(str || '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    }

    // --- LOGIKA BISNIS ---
    function calculateTcSalary(totalTC) {
      return totalTC * SALES_COMMISSION_USD * DOLLAR_RATE;
    }

    function calculateBonus(totalRevenue, conversionRatePercent) {
      if (!conversionRatePercent) return { bonusPercent: 0, bonusAmount: 0, conversion: 0, level: 1, levelName: 'Lvl 1' };

      let bonusPercent = 0;
      // Logic Tier
      if (totalRevenue <= 16830000) {
        if (conversionRatePercent < 30) bonusPercent = 4.5;
        else if (conversionRatePercent < 40) bonusPercent = 5.0;
        else if (conversionRatePercent < 50) bonusPercent = 6.0;
        else bonusPercent = 7.0;
      } else if (totalRevenue <= 33660000) {
        if (conversionRatePercent < 30) bonusPercent = 5.5;
        else if (conversionRatePercent < 40) bonusPercent = 6.0;
        else if (conversionRatePercent < 50) bonusPercent = 7.0;
        else bonusPercent = 8.0;
      } else if (totalRevenue <= 50490000) {
        if (conversionRatePercent < 30) bonusPercent = 7.0;
        else if (conversionRatePercent < 40) bonusPercent = 8.0;
        else if (conversionRatePercent < 50) bonusPercent = 9.0;
        else bonusPercent = 10.5;
      } else if (totalRevenue <= 67320000) {
        if (conversionRatePercent < 30) bonusPercent = 8.5;
        else if (conversionRatePercent < 40) bonusPercent = 10.0;
        else if (conversionRatePercent < 50) bonusPercent = 11.5;
        else bonusPercent = 13.0;
      } else {
        if (conversionRatePercent < 30) bonusPercent = 10.5;
        else if (conversionRatePercent < 40) bonusPercent = 12.0;
        else if (conversionRatePercent < 50) bonusPercent = 13.5;
        else bonusPercent = 15.0;
      }
      
      const bonusAmount = totalRevenue * (bonusPercent / 100);
      
      let level = 1;
      let levelName = 'Lvl 1';
      if (totalRevenue > 67320000) { level = 5; levelName = 'MAX'; }
      else if (totalRevenue > 50490000) { level = 4; levelName = 'Lvl 4'; }
      else if (totalRevenue > 33660000) { level = 3; levelName = 'Lvl 3'; }
      else if (totalRevenue > 16830000) { level = 2; levelName = 'Lvl 2'; }
      
      return { bonusPercent, bonusAmount, conversion: conversionRatePercent, level, levelName };
    }

    // --- DATA MANAGEMENT ---
    function loadAllData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return [];
      try { return JSON.parse(raw); } catch { return []; }
    }

    function saveAllData(arr) { localStorage.setItem(STORAGE_KEY, JSON.stringify(arr)); }
    
    function addEntry(entry) { const arr = loadAllData(); arr.push(entry); saveAllData(arr); }
    
    function updateEntry(id, updated) {
      const arr = loadAllData();
      const idx = arr.findIndex(r => r.id === id);
      if (idx !== -1) { arr[idx] = { ...arr[idx], ...updated }; saveAllData(arr); return true; }
      return false;
    }

    function deleteEntry(id) { let arr = loadAllData(); arr = arr.filter(r => r.id !== id); saveAllData(arr); }
    function bulkDelete(ids) { let arr = loadAllData(); arr = arr.filter(r => !ids.includes(r.id)); saveAllData(arr); }

    function getTarget() { 
      try { return JSON.parse(localStorage.getItem(TARGET_KEY)); } catch { return null; } 
    }
    
    function saveTarget(monthKey, targetRevenue) {
      const data = { monthKey, targetRevenue, updatedAt: new Date().toISOString() };
      localStorage.setItem(TARGET_KEY, JSON.stringify(data));
    }

    // --- UI UPDATES ---
    const monthSelector = document.getElementById('monthSelector');
    const periodFilter = document.getElementById('periodFilter');
    const tbody = document.getElementById('tbody');
    const searchInput = document.getElementById('searchInput');
    const statusFilter = document.getElementById('statusFilter');
    const courseFilter = document.getElementById('courseFilter');
    const entryForm = document.getElementById('entryForm');
    const editingIdInput = document.getElementById('editingId');

    let currentSort = { field: 'date', direction: 'desc' };
    let selectedRows = new Set();
    let currentNoteText = '';

    function updateTargetUI() {
      const targetData = getTarget();
      const currentMonth = monthSelector.value;
      const section = document.getElementById('targetSection');
      
      if (!targetData || targetData.monthKey !== currentMonth) {
        section.classList.add('hidden');
        return;
      }

      const data = loadAllData();
      const filtered = data.filter(r => r.monthKey === currentMonth);
      let totalRevenue = filtered.reduce((sum, r) => 
        String(r.buyOrNot).toLowerCase().includes('buy') ? sum + (Number(r.revenue) || 0) : sum, 0);
      
      const targetRev = targetData.targetRevenue || 0;
      const percent = targetRev > 0 ? Math.min((totalRevenue / targetRev) * 100, 100) : 0;
      const remaining = Math.max(targetRev - totalRevenue, 0);

      section.classList.remove('hidden');
      document.getElementById('targetDesc').textContent = formatRp(targetRev);
      document.getElementById('targetProgress').style.width = percent + '%';
      document.getElementById('targetCurrent').textContent = formatRp(totalRevenue);
      document.getElementById('targetPercent').textContent = percent.toFixed(1) + '%';
      document.getElementById('targetRemaining').textContent = formatRp(remaining);
    }

    function refreshMonthOptions() {
      const all = loadAllData();
      const set = new Set(all.map(r => r.monthKey));
      const now = new Date();
      set.add(`${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`);
      const arr = Array.from(set).sort().reverse();
      const current = monthSelector.value || arr[0] || '';
      
      monthSelector.innerHTML = '';
      arr.forEach(k => {
        const opt = document.createElement('option');
        const [y,m] = k.split('-');
        opt.value = k;
        opt.textContent = new Date(y, m-1).toLocaleString('id-ID', { month: 'long', year: 'numeric' });
        monthSelector.appendChild(opt);
      });
      if (arr.length > 0) monthSelector.value = current && arr.includes(current) ? current : arr[0];
      updateSelectedMonthLabel();
    }

    function updateSelectedMonthLabel() {
      const v = monthSelector.value;
      const [y,m] = (v || '').split('-');
      document.getElementById('selectedMonth').textContent = 
        v ? new Date(y, m-1).toLocaleString('id-ID', { month: 'long', year: 'numeric' }) : '';
      
      const p = periodFilter.value;
      document.getElementById('selectedPeriod').textContent = p ? p : '';
    }

    function refreshCourseFilter() {
      const all = loadAllData();
      const courses = new Set(all.map(r => r.course).filter(c => c));
      const current = courseFilter.value;
      
      courseFilter.innerHTML = '<option value="">All Courses</option>';
      COURSES.forEach(c => {
        const opt = document.createElement('option'); opt.value = c; opt.textContent = c; courseFilter.appendChild(opt);
      });
      Array.from(courses).sort().forEach(c => {
        if (!COURSES.includes(c)) {
          const opt = document.createElement('option'); opt.value = c; opt.textContent = c + ' (other)'; courseFilter.appendChild(opt);
        }
      });
      if (current) courseFilter.value = current;
    }

    function computeStats(filtered, allData) {
      const tcTotal = filtered.length;
      let sales = 0, totalRevenue = 0, pending = 0;

      filtered.forEach(r => {
        const status = String(r.buyOrNot || '').toLowerCase();
        if (status.includes('buy')) { sales++; totalRevenue += Number(r.revenue) || 0; } 
        else if (status.includes('pending')) { pending++; }
      });

      const conversionRatePercent = tcTotal === 0 ? 0 : (sales / tcTotal) * 100;
      const aov = sales === 0 ? 0 : (totalRevenue / sales);
      const tcSalary = calculateTcSalary(tcTotal);
      const bonusData = calculateBonus(totalRevenue, conversionRatePercent);

      // Prev Month Comparison Logic
      const currentMonthKey = monthSelector.value;
      let prevSales = 0, salesChange = 0, revenueChange = 0;
      
      if (currentMonthKey) {
        const [y, m] = currentMonthKey.split('-');
        const prevMonth = m === '01' ? `${parseInt(y)-1}-12` : `${y}-${String(parseInt(m)-1).padStart(2,'0')}`;
        const prevData = allData.filter(r => r.monthKey === prevMonth);
        prevSales = prevData.filter(r => String(r.buyOrNot).toLowerCase().includes('buy')).length;
        const prevRevenue = prevData.reduce((sum, r) => String(r.buyOrNot).toLowerCase().includes('buy') ? sum + (Number(r.revenue)||0) : sum, 0);
        
        salesChange = sales - prevSales;
        revenueChange = totalRevenue - prevRevenue;
      }

      return { tcTotal, sales, conversion: conversionRatePercent, aov, totalRevenue, pending, tcSalary, bonusData, salesChange, revenueChange };
    }

    function renderTable() {
      const data = loadAllData();
      const selectedMonth = monthSelector.value;
      const selectedPeriod = periodFilter.value;
      const q = (searchInput.value || '').toLowerCase().trim();
      const status = statusFilter.value;
      const course = courseFilter.value;
      
      let filtered = data.filter(r => {
        if (selectedMonth && r.monthKey !== selectedMonth) return false;
        if (selectedPeriod && getPeriodFromDate(r.date) !== selectedPeriod) return false;
        if (q && !`${r.childName} ${r.note} ${r.course}`.toLowerCase().includes(q)) return false;
        if (status && r.buyOrNot !== status) return false;
        if (course && r.course !== course) return false;
        return true;
      });

      // Sorting
      filtered.sort((a, b) => {
        let valA = a[currentSort.field], valB = b[currentSort.field];
        if (currentSort.field === 'revenue') { valA = Number(valA)||0; valB = Number(valB)||0; }
        if (currentSort.field === 'date') { valA = new Date(valA||0); valB = new Date(valB||0); }
        return currentSort.direction === 'asc' ? (valA > valB ? 1 : -1) : (valA < valB ? 1 : -1);
      });

      // Update Stats
      const stats = computeStats(filtered, data);
      document.getElementById('statTcTotal').textContent = stats.tcTotal;
      document.getElementById('statSales').textContent = stats.sales;
      document.getElementById('statConversion').textContent = stats.conversion.toFixed(1) + '%';
      document.getElementById('statRevenue').textContent = formatRp(stats.totalRevenue);
      document.getElementById('statAov').textContent = formatRp(stats.aov);
      document.getElementById('statPending').textContent = stats.pending;
      document.getElementById('statTcSalary').textContent = formatRp(stats.tcSalary);
      document.getElementById('statBonus').textContent = formatRp(stats.bonusData.bonusAmount);
      document.getElementById('bonusPercent').textContent = stats.bonusData.bonusPercent.toFixed(1) + '%';
      document.getElementById('bonusLevel').textContent = stats.bonusData.levelName;
      
      const barWidth = Math.min((stats.bonusData.conversion / 50) * 100, 100);
      document.getElementById('bonusBar').style.width = barWidth + '%';
      
      // Changes
      const revEl = document.getElementById('statRevChange');
      revEl.innerHTML = stats.revenueChange >= 0 ? 
        `<span class="text-emerald-400">‚ñ≤ ${formatRp(stats.revenueChange)}</span> vs prev` : 
        `<span class="text-rose-400">‚ñº ${formatRp(Math.abs(stats.revenueChange))}</span> vs prev`;

      document.getElementById('recordCount').textContent = `${filtered.length} records`;
      updateSelectedMonthLabel();

      // Render Rows
      tbody.innerHTML = '';
      if (filtered.length === 0) {
        document.getElementById('emptyState').classList.remove('hidden');
        return;
      }
      document.getElementById('emptyState').classList.add('hidden');

      filtered.forEach(r => {
        const tr = document.createElement('tr');
        tr.className = "hover:bg-white/5 transition-colors group";
        tr.dataset.id = r.id;
        
        let badgeClass = 'bg-slate-700 text-slate-300 border-slate-600';
        let statusIcon = '‚Ä¢';
        if (r.buyOrNot === 'Buy') { badgeClass = 'bg-emerald-500/10 text-emerald-400 border-emerald-500/20'; statusIcon = '‚úÖ'; }
        else if (r.buyOrNot === 'Not') { badgeClass = 'bg-rose-500/10 text-rose-400 border-rose-500/20'; statusIcon = '‚ùå'; }
        else if (r.buyOrNot === 'Pending') { badgeClass = 'bg-amber-500/10 text-amber-400 border-amber-500/20'; statusIcon = '‚è≥'; }

        const isSelected = selectedRows.has(r.id);

        const noteText = r.note ? String(r.note) : '';
        const notePreview = escapeHtml(truncate(noteText, 40));
        const noteFullTitle = escapeHtml(noteText);

        tr.innerHTML = `
          <td class="p-4"><input type="checkbox" class="row-checkbox rounded bg-transparent border-slate-600 text-amber-500 focus:ring-0" data-id="${r.id}" ${isSelected ? 'checked' : ''}></td>
          <td class="p-4">
            <div class="font-medium text-white">${r.date || '-'}</div>
            ${r.time ? `<div class="text-[10px] text-slate-500">${r.time}</div>` : ''}
          </td>
          <td class="p-4">
            <div class="font-medium text-slate-200">${escapeHtml(r.childName || '-')}</div>
            ${r.crm ? `<a href="${escapeHtml(r.crm)}" target="_blank" class="text-[10px] text-blue-400 hover:underline flex items-center gap-1">üîó CRM</a>` : ''}
          </td>
          <td class="p-4"><span class="inline-block px-2 py-0.5 rounded text-[10px] bg-white/5 border border-white/10 text-slate-400 whitespace-nowrap">${escapeHtml(r.course || '-')}</span></td>
          <td class="p-4">
            ${noteText ? `
              <div class="flex items-center gap-2">
                <span class="truncate max-w-[220px] sm:max-w-[260px] md:max-w-[320px] text-slate-300" title="${noteFullTitle}">${notePreview}</span>
                <button class="noteBtn text-amber-400 hover:text-amber-300 text-xs underline decoration-dotted" data-id="${r.id}" title="View Note">View</button>
              </div>
            ` : `<span class="text-slate-600">-</span>`}
          </td>
          <td class="p-4"><span class="inline-flex items-center gap-1 px-2 py-1 rounded-md border text-xs font-medium ${badgeClass}">${statusIcon} ${r.buyOrNot || '-'}</span></td>
          <td class="p-4 font-mono text-emerald-400 font-medium">${formatRp(r.revenue)}</td>
          <td class="p-4 text-right">
            <div class="flex justify-end gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
              <button class="editBtn p-1.5 hover:bg-blue-500/20 text-blue-400 rounded" data-id="${r.id}" title="Edit">‚úèÔ∏è</button>
              <button class="duplicateRowBtn p-1.5 hover:bg-slate-700 text-slate-400 rounded" data-id="${r.id}" title="Duplicate">üìã</button>
              <button class="deleteBtn p-1.5 hover:bg-rose-500/20 text-rose-400 rounded" data-id="${r.id}" title="Delete">üóëÔ∏è</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      attachRowListeners();
      updateTargetUI();
    }

    function attachRowListeners() {
       document.querySelectorAll('.row-checkbox').forEach(cb => {
        cb.addEventListener('change', (e) => {
          e.target.checked ? selectedRows.add(e.target.dataset.id) : selectedRows.delete(e.target.dataset.id);
          updateBulkDeleteBtn();
        });
      });
      document.querySelectorAll('.editBtn').forEach(btn => btn.addEventListener('click', e => startEdit(e.currentTarget.dataset.id)));
      document.querySelectorAll('.duplicateRowBtn').forEach(btn => btn.addEventListener('click', e => duplicateRecord(e.currentTarget.dataset.id)));
      document.querySelectorAll('.deleteBtn').forEach(btn => btn.addEventListener('click', e => {
        if(confirm('Delete record?')) { deleteEntry(e.currentTarget.dataset.id); refresh(); showToast('Deleted', 'Record removed permanently', 'üóëÔ∏è'); }
      }));
      document.querySelectorAll('.noteBtn').forEach(btn => btn.addEventListener('click', e => {
        const id = e.currentTarget.dataset.id;
        const rec = loadAllData().find(r => r.id === id);
        currentNoteText = rec && rec.note ? rec.note : '';
        document.getElementById('noteContent').textContent = currentNoteText || '(no note)';
        toggleModal('noteModal', true);
      }));
    }

    function updateBulkDeleteBtn() {
      const btn = document.getElementById('bulkDeleteBtn');
      if (selectedRows.size > 0) {
        btn.style.display = 'inline-flex';
        document.getElementById('selectedCount').textContent = selectedRows.size;
      } else {
        btn.style.display = 'none';
      }
    }

    function startEdit(id) {
      const rec = loadAllData().find(r => r.id === id);
      if (!rec) return;
      
      editingIdInput.value = rec.id;
      document.getElementById('date').value = rec.date || '';
      document.getElementById('time').value = rec.time || '';
      document.getElementById('crm').value = rec.crm || '';
      document.getElementById('childName').value = rec.childName || '';
      document.getElementById('course').value = rec.course || '';
      document.getElementById('buyOrNot').value = rec.buyOrNot || '';
      document.getElementById('layer').value = rec.layer || '';
      document.getElementById('revenue').value = rec.revenue || '';
      document.getElementById('note').value = rec.note || '';
      
      document.getElementById('formTitle').textContent = 'Edit Record';
      document.getElementById('formTitleIcon').classList.replace('text-amber-400', 'text-blue-400');
      document.getElementById('duplicateBtn').classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function clearForm() {
      editingIdInput.value = '';
      entryForm.reset();
      document.getElementById('formTitle').textContent = 'New Record';
      document.getElementById('formTitleIcon').classList.replace('text-blue-400', 'text-amber-400');
      document.getElementById('duplicateBtn').classList.add('hidden');
    }

    function duplicateRecord(id) {
      const rec = loadAllData().find(r => r.id === id);
      if (rec) {
        addEntry({ ...rec, id: uid(), createdAt: new Date().toISOString() });
        refresh();
        showToast('Duplicated', 'Record copied successfully', 'üìã');
      }
    }

    function refresh() { refreshMonthOptions(); refreshCourseFilter(); renderTable(); }

    // --- CSV EXPORT/IMPORT ---
    function exportCSV(all) {
      const data = loadAllData();
      const filtered = all ? data : data.filter(r => 
        r.monthKey === monthSelector.value && 
        (!periodFilter.value || getPeriodFromDate(r.date) === periodFilter.value)
      );
      
      if (!filtered.length) return showToast('No Data', 'Nothing to export', '‚ö†Ô∏è');

      const headers = ['id','date','time','crm','childName','course','buyOrNot','layer','revenue','note','monthKey'];
      const csv = [headers.join(','), ...filtered.map(r => headers.map(h => `"${String(r[h]||'').replace(/"/g,'""')}"`).join(','))].join('\n');
      
      const a = document.createElement('a');
      a.href = URL.createObjectURL(new Blob([csv], {type: 'text/csv'}));
      a.download = `mrj_export_${all ? 'ALL' : monthSelector.value}.csv`;
      a.click();
    }

    function importCSV(file) {
      const reader = new FileReader();
      reader.onload = e => {
        const lines = e.target.result.split('\n');
        const headers = lines[0].split(',').map(h => h.replace(/"/g, '').trim());
        let count = 0;
        for(let i=1; i<lines.length; i++) {
          if(!lines[i].trim()) continue;
          const val = lines[i].match(/(".*?"|[^,]+)(?=\s*,|\s*$)/g) || [];
          const obj = { id: uid(), createdAt: new Date().toISOString() };
          headers.forEach((h, idx) => obj[h] = val[idx] ? val[idx].replace(/^"|"$/g, '').replace(/""/g, '"') : '');
          if(obj.date) { addEntry(obj); count++; }
        }
        refresh(); toggleModal('importModal', false); showToast('Imported', `${count} records added`, 'üì•');
      };
      reader.readAsText(file);
    }

    // --- CHARTS & MODALS ---
    function showCharts() {
      toggleModal('chartModal', true);
      const data = loadAllData();
      
      // 1. Status
      const statusCounts = { Buy:0, Not:0, Pending:0 };
      data.forEach(r => { if(statusCounts[r.buyOrNot] !== undefined) statusCounts[r.buyOrNot]++; });
      const total = Math.max(data.length, 1);
      document.getElementById('statusChart').innerHTML = `
        <div class="flex items-end justify-around h-full pb-4 gap-4">
          <div class="w-1/3 bg-emerald-500/20 rounded-t-lg relative group" style="height:${(statusCounts.Buy/total)*100}%">
             <div class="absolute bottom-0 w-full text-center pb-2 font-bold text-emerald-400">${statusCounts.Buy}</div>
             <div class="absolute -bottom-6 w-full text-center text-[10px] text-slate-500">Buy</div>
          </div>
           <div class="w-1/3 bg-rose-500/20 rounded-t-lg relative group" style="height:${(statusCounts.Not/total)*100}%">
             <div class="absolute bottom-0 w-full text-center pb-2 font-bold text-rose-400">${statusCounts.Not}</div>
             <div class="absolute -bottom-6 w-full text-center text-[10px] text-slate-500">Not</div>
          </div>
           <div class="w-1/3 bg-amber-500/20 rounded-t-lg relative group" style="height:${(statusCounts.Pending/total)*100}%">
             <div class="absolute bottom-0 w-full text-center pb-2 font-bold text-amber-400">${statusCounts.Pending}</div>
             <div class="absolute -bottom-6 w-full text-center text-[10px] text-slate-500">Pending</div>
          </div>
        </div>
      `;

      // 2. Course
      const courses = {};
      data.forEach(r => courses[r.course] = (courses[r.course]||0)+1);
      const sortedCourses = Object.entries(courses).sort((a,b)=>b[1]-a[1]).slice(0,8);
      document.getElementById('courseBreakdown').innerHTML = sortedCourses.map(([name, count]) => `
        <div class="flex items-center justify-between text-xs mb-2">
          <span class="text-slate-400 truncate w-32" title="${escapeHtml(name)}">${escapeHtml(name)}</span>
          <div class="flex items-center gap-2 flex-1">
            <div class="h-1.5 bg-slate-800 rounded-full flex-1 overflow-hidden">
              <div class="h-full bg-indigo-500 rounded-full" style="width: ${(count/total)*100}%"></div>
            </div>
            <span class="font-bold text-white w-6 text-right">${count}</span>
          </div>
        </div>
      `).join('');

      // 3. Trend placeholder
      document.getElementById('trendChart').innerHTML = `<div class="flex h-full items-center justify-center text-slate-500 text-xs italic">Chart visualization requires chart library (Chart.js). Using CSS bars above for lightweight demo.</div>`;
    }

    function toggleModal(id, show) {
      const m = document.getElementById(id);
      const bg = document.getElementById('modalBackdrop');
      if(show) { m.classList.remove('hidden'); bg.classList.remove('hidden'); }
      else { m.classList.add('hidden'); if(!document.querySelector('.fixed.z-50:not(.hidden):not(#modalBackdrop)')) bg.classList.add('hidden'); }
    }

    function toggleTopLoader(show) {
      const el = document.getElementById('topLoader');
      if(!el) return;
      el.style.display = show ? 'block' : 'none';
    }

    // --- EVENT LISTENERS ---
    document.addEventListener('DOMContentLoaded', () => {
      refresh();

      // Filters
      ['monthSelector','periodFilter','searchInput','statusFilter','courseFilter'].forEach(id => {
        document.getElementById(id).addEventListener(id === 'searchInput' ? 'input' : 'change', renderTable);
      });
      document.getElementById('refreshBtn').addEventListener('click', () => { toggleTopLoader(true); setTimeout(()=>{ refresh(); toggleTopLoader(false); }, 450); showToast('Refreshed'); });
      document.getElementById('clearFormBtn').addEventListener('click', clearForm);
      
      // Menu
      const menuBtn = document.getElementById('menuBtn');
      const menu = document.getElementById('menu');
      menuBtn.addEventListener('click', (e) => { e.stopPropagation(); menu.classList.toggle('hidden'); });
      document.addEventListener('click', (e) => { if (!menu.contains(e.target) && !menuBtn.contains(e.target)) menu.classList.add('hidden'); });

      // Modals
      document.getElementById('shortcutsBtn').addEventListener('click', () => toggleModal('shortcutsModal', true));
      document.getElementById('closeShortcutsBtn').addEventListener('click', () => toggleModal('shortcutsModal', false));
      
      document.getElementById('chartBtn').addEventListener('click', showCharts);
      document.getElementById('closeChartBtn').addEventListener('click', () => toggleModal('chartModal', false));

      document.getElementById('targetBtn').addEventListener('click', () => {
        toggleModal('targetModal', true);
        const t = getTarget();
        document.getElementById('targetInput').value = (t && t.monthKey === monthSelector.value) ? t.targetRevenue : '';
      });
      document.getElementById('editTargetBtn')?.addEventListener('click', () => document.getElementById('targetBtn').click());
      document.getElementById('cancelTargetBtn').addEventListener('click', () => toggleModal('targetModal', false));
      document.getElementById('saveTargetBtn').addEventListener('click', () => {
        saveTarget(monthSelector.value, document.getElementById('targetInput').value);
        toggleModal('targetModal', false);
        updateTargetUI();
        showToast('Target Saved');
      });

      // Note modal controls
      document.getElementById('closeNoteBtn').addEventListener('click', () => toggleModal('noteModal', false));
      document.getElementById('closeNoteBtn2').addEventListener('click', () => toggleModal('noteModal', false));
      document.getElementById('copyNoteBtn').addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(currentNoteText || '');
          showToast('Copied', 'Note copied to clipboard', 'üìã');
        } catch {
          showToast('Failed', 'Unable to copy', '‚ö†Ô∏è');
        }
      });

      // Form
      entryForm.addEventListener('submit', e => {
        e.preventDefault();
        const id = editingIdInput.value;
        const data = {
          id: id || uid(),
          date: document.getElementById('date').value,
          time: document.getElementById('time').value,
          crm: document.getElementById('crm').value,
          childName: document.getElementById('childName').value,
          course: document.getElementById('course').value,
          buyOrNot: document.getElementById('buyOrNot').value,
          layer: document.getElementById('layer').value,
          revenue: document.getElementById('revenue').value,
          note: document.getElementById('note').value,
          monthKey: monthKeyFromDateStr(document.getElementById('date').value),
          createdAt: new Date().toISOString()
        };

        if(id) updateEntry(id, data); else addEntry(data);
        clearForm(); refresh(); showToast('Success', 'Record saved successfully');
      });

      document.getElementById('duplicateBtn').addEventListener('click', () => duplicateRecord(editingIdInput.value));

      // Bulk
      document.getElementById('selectAll').addEventListener('change', (e) => {
        document.querySelectorAll('.row-checkbox').forEach(cb => {
          cb.checked = e.target.checked;
          e.target.checked ? selectedRows.add(cb.dataset.id) : selectedRows.delete(cb.dataset.id);
        });
        updateBulkDeleteBtn();
      });
      document.getElementById('bulkDeleteBtn').addEventListener('click', () => {
        if(confirm(`Delete ${selectedRows.size} items?`)) {
          bulkDelete(Array.from(selectedRows)); selectedRows.clear(); refresh(); showToast('Deleted Batch');
        }
      });

      // Sort
      document.querySelectorAll('[data-sort]').forEach(el => el.addEventListener('click', () => {
        currentSort.direction = (currentSort.field === el.dataset.sort && currentSort.direction === 'desc') ? 'asc' : 'desc';
        currentSort.field = el.dataset.sort;
        renderTable();
      }));

      // Export/Import/Reset
      document.getElementById('exportCurrentBtn').addEventListener('click', () => exportCSV(false));
      document.getElementById('exportAllBtn').addEventListener('click', () => exportCSV(true));
      
      document.getElementById('importBtn').addEventListener('click', () => toggleModal('importModal', true));
      document.getElementById('cancelImportBtn').addEventListener('click', () => toggleModal('importModal', false));
      document.getElementById('confirmImportBtn').addEventListener('click', () => {
        const f = document.getElementById('importFile').files[0];
        if(f) importCSV(f); else showToast('Error', 'Select file first', '‚ö†Ô∏è');
      });

      document.getElementById('resetBtn').addEventListener('click', () => toggleModal('pwModal', true));
      document.getElementById('cancelPwBtn').addEventListener('click', () => toggleModal('pwModal', false));
      document.getElementById('confirmPwBtn').addEventListener('click', () => {
        if(document.getElementById('pwInput').value === RESET_PASSWORD) {
          localStorage.removeItem(STORAGE_KEY); localStorage.removeItem(TARGET_KEY);
          toggleModal('pwModal', false); refresh(); showToast('Reset Complete', 'System wiped clean', 'üí•');
        } else showToast('Access Denied', 'Wrong password', '‚õî');
      });

      // Keys
      document.addEventListener('keydown', e => {
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'k') { e.preventDefault(); document.getElementById('searchInput').focus(); }
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'n') { e.preventDefault(); clearForm(); document.getElementById('date').focus(); }
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'e') { e.preventDefault(); exportCSV(false); }
        if((e.ctrlKey||e.metaKey) && e.key.toLowerCase() === 'r') { e.preventDefault(); toggleTopLoader(true); setTimeout(()=>{ refresh(); toggleTopLoader(false); }, 400); }
        if(e.key === 'Escape') document.querySelectorAll('.fixed.z-50').forEach(m => m.classList.add('hidden'));
      });
    });
  </script>
</body>
</html>

