
<!DOCTYPE html>
<html lang="id" data-theme="dark">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width,initial-scale=1"/>
    <title>Algonova Nebula v4.0 | AI Educational Calculator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <!-- Confetti -->
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <!-- QRCode -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <style>
        /* --- CORE VARIABLES --- */
        :root {
            --primary: #6366f1; --primary-glow: rgba(99, 102, 241, 0.5);
            --secondary: #a855f7; --accent: #ec4899;
            --bg-deep: #030712; --bg-surface: #0f172a; --bg-card: #1e293b;
            --text-main: #f8fafc; --text-muted: #94a3b8;
            --border: rgba(255,255,255,0.08);
            --glass: rgba(15, 23, 42, 0.7);
            --gradient-main: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
        }

        [data-theme="light"] {
            --bg-deep: #f0f4f8; --bg-surface: #ffffff; --bg-card: #ffffff;
            --text-main: #0f172a; --text-muted: #64748b;
            --border: rgba(0,0,0,0.1);
            --glass: rgba(255, 255, 255, 0.85);
        }

        /* --- GLOBAL STYLES --- */
        * { box-sizing: border-box; outline: none; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Plus Jakarta Sans', sans-serif;
            background-color: var(--bg-deep); color: var(--text-main);
            overflow-x: hidden; margin: 0; transition: background 0.3s ease;
        }
        
        .font-display { family: 'Outfit', sans-serif; }

        /* --- ANIMATED BACKGROUND --- */
        .nebula-bg { position: fixed; inset: 0; z-index: -1; overflow: hidden; pointer-events: none; }
        .nebula-orb {
            position: absolute; border-radius: 50%; filter: blur(100px); opacity: 0.4;
            animation: floatOrb 20s infinite ease-in-out;
        }
        .orb-1 { width: 600px; height: 600px; background: var(--primary); top: -20%; right: -10%; animation-delay: 0s; }
        .orb-2 { width: 500px; height: 500px; background: var(--accent); bottom: -10%; left: -10%; animation-delay: -5s; }
        .orb-3 { width: 300px; height: 300px; background: var(--secondary); top: 40%; left: 40%; animation-delay: -10s; opacity: 0.2; }
        
        @keyframes floatOrb {
            0%, 100% { transform: translate(0, 0) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.95); }
        }

        /* --- GLASSMORPHISM CARD --- */
        .glass-card {
            background: var(--bg-card);
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: transform 0.1s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            position: relative; overflow: hidden;
            transform-style: preserve-3d; /* For 3D Tilt */
        }
        
        .glass-card::after { /* Shine effect */
            content: ""; position: absolute; top: 0; left: -100%; width: 50%; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
            transform: skewX(-25deg); transition: 0.5s; pointer-events: none;
        }
        .glass-card:hover::after { left: 150%; transition: 0.7s ease-in-out; }
        .glass-card:hover { border-color: rgba(99, 102, 241, 0.4); }

        /* --- HEADER --- */
        .header-glass {
            position: sticky; top: 0; z-index: 50;
            background: var(--glass); backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--border);
            padding: 1rem 0;
        }

        /* --- INPUTS --- */
        .input-modern {
            width: 100%; padding: 0.75rem 1rem;
            background: rgba(0,0,0,0.2); border: 1px solid var(--border);
            border-radius: 12px; color: var(--text-main); font-weight: 500;
            transition: all 0.2s; font-family: 'Plus Jakarta Sans', sans-serif;
        }
        [data-theme="light"] .input-modern { background: #f1f5f9; }
        .input-modern:focus {
            border-color: var(--primary); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background: rgba(0,0,0,0.3);
        }

        /* --- BUTTONS --- */
        .btn-nebula {
            background: var(--gradient-main); color: white;
            border: none; padding: 0.75rem 1.5rem; border-radius: 12px;
            font-weight: 600; cursor: pointer; position: relative; overflow: hidden;
            transition: all 0.3s; box-shadow: 0 4px 15px var(--primary-glow);
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
        }
        .btn-nebula:hover { transform: translateY(-2px); box-shadow: 0 8px 25px var(--primary-glow); }
        .btn-nebula:active { transform: translateY(0); }
        
        .btn-outline {
            background: transparent; border: 1px solid var(--border); color: var(--text-muted);
            padding: 0.75rem 1.5rem; border-radius: 12px; cursor: pointer; font-weight: 600;
            transition: all 0.2s;
        }
        .btn-outline:hover { border-color: var(--primary); color: var(--text-main); background: rgba(99, 102, 241, 0.1); }

        /* --- GRID LAYOUT --- */
        .main-layout {
            display: grid; grid-template-columns: 1fr 400px; gap: 1.5rem;
            max-width: 1600px; margin: 0 auto; padding: 1.5rem;
        }
        .packages-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 1rem; }

        /* --- SKILL RADAR & STATS --- */
        .stats-pill {
            background: rgba(255,255,255,0.05); padding: 0.5rem 1rem; border-radius: 12px;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 1px solid var(--border);
        }

        /* --- MODALS & EXTRAS --- */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px);
            z-index: 100; display: none; place-items: center; opacity: 0; transition: opacity 0.3s;
        }
        .modal-overlay.active { display: grid; opacity: 1; }
        .modal-box {
            background: var(--bg-card); border: 1px solid var(--border); border-radius: 24px;
            width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto;
            transform: scale(0.9); transition: transform 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        .modal-overlay.active .modal-box { transform: scale(1); }

        /* --- PRINT STYLES (Professional Invoice) --- */
        @media print {
            body { background: white; color: black; }
            .header-glass, .fab-container, .packages-area, .theme-toggle, .no-print { display: none !important; }
            .modal-overlay { position: static; background: white; backdrop-filter: none; display: block !important; opacity: 1; }
            .modal-box { 
                box-shadow: none; border: none; width: 100%; max-width: 100%; 
                transform: none; background: white; position: static;
            }
            #print-area { display: block !important; }
            .main-layout { display: none; }
        }
        #print-area { display: none; }

        /* --- RESPONSIVE --- */
        @media (max-width: 1024px) { .main-layout { grid-template-columns: 1fr; } }
    </style>
</head>
<body>

    <!-- Background Animation -->
    <div class="nebula-bg">
        <div class="nebula-orb orb-1"></div>
        <div class="nebula-orb orb-2"></div>
        <div class="nebula-orb orb-3"></div>
    </div>

    <!-- Header -->
    <header class="header-glass">
        <div class="max-w-[1600px] mx-auto px-6 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-indigo-500 to-purple-600 flex items-center justify-center text-white shadow-lg shadow-indigo-500/30">
                    <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                </div>
                <div>
                    <h1 class="font-display text-xl font-bold tracking-tight">Algonova <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">Nebula</span></h1>
                    <p class="text-xs text-muted font-medium">v4.0 ‚Ä¢ Intelligent Calculation System</p>
                </div>
            </div>

            <div class="flex items-center gap-4">
                <div class="text-right hidden sm:block">
                    <div class="text-[10px] text-muted font-bold uppercase tracking-wider">Estimated Investment</div>
                    <div id="headerTotal" class="text-xl font-bold font-display text-transparent bg-clip-text bg-gradient-to-r from-white to-gray-400">Rp 0</div>
                </div>
                <button onclick="toggleTheme()" class="w-10 h-10 rounded-full bg-slate-800/50 border border-white/10 flex items-center justify-center hover:bg-slate-700 transition">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Layout -->
    <main class="main-layout">
        
        <!-- Left: Packages -->
        <div class="packages-area">
            <!-- Tools Bar -->
            <div class="flex gap-3 mb-6 overflow-x-auto pb-2 no-scrollbar">
                <button onclick="openBudgetModal()" class="btn-outline flex items-center gap-2 whitespace-nowrap">
                    <span>üí∞</span> Budget AI
                </button>
                <button onclick="resetAll()" class="btn-outline flex items-center gap-2 whitespace-nowrap text-red-400 border-red-500/20 hover:border-red-500 hover:bg-red-500/10">
                    <span>üîÑ</span> Reset
                </button>
                <div class="h-10 w-[1px] bg-white/10 mx-2"></div>
                <div class="flex items-center gap-2 bg-slate-800/50 px-3 rounded-lg border border-white/5">
                    <span class="text-xs text-muted uppercase font-bold">Mode:</span>
                    <select id="currencyMode" class="bg-transparent text-sm font-medium border-none outline-none text-white">
                        <option value="IDR">üáÆüá© IDR</option>
                        <option value="USD">üá∫üá∏ USD (Approx)</option>
                    </select>
                </div>
            </div>

            <!-- Packages Grid -->
            <div id="packagesGrid" class="packages-grid">
                <!-- Javascript will inject cards here -->
            </div>

            <!-- AI Recommendations Section -->
            <div class="mt-8">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="font-display text-lg font-bold flex items-center gap-2">
                        <span class="text-purple-400">ü§ñ</span> Nebula AI Recommender
                    </h3>
                </div>
                
                <div class="glass-card p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                        <div>
                            <label class="text-xs font-bold text-muted uppercase mb-2 block">Child's Age</label>
                            <input type="number" id="childAge" min="5" max="17" placeholder="e.g. 10" class="input-modern" oninput="updateRecommendations()">
                        </div>
                        <div>
                            <label class="text-xs font-bold text-muted uppercase mb-2 block">Primary Interest</label>
                            <select id="childInterest" class="input-modern" onchange="updateRecommendations()">
                                <option value="any">‚ú® All Interests</option>
                                <option value="coding">üíª Coding & Logic</option>
                                <option value="design">üé® Art & Design</option>
                                <option value="math">üìê Mathematics</option>
                                <option value="game">üéÆ Game Dev</option>
                            </select>
                        </div>
                    </div>
                    <div id="recommendationsOutput" class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div class="col-span-full text-center py-8 text-muted text-sm border border-dashed border-white/10 rounded-xl">
                            Enter details to get AI-powered course suggestions
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right: Summary & Analytics -->
        <div class="summary-area space-y-4">
            
            <!-- Total Card -->
            <div class="glass-card p-6 relative overflow-hidden group">
                <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-500/20 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                
                <div class="relative z-10">
                    <div class="text-xs font-bold text-muted uppercase tracking-widest mb-1">Total Investment</div>
                    <div id="grandTotal" class="text-4xl font-display font-black text-transparent bg-clip-text bg-gradient-to-r from-white to-indigo-200 mb-2">Rp 0</div>
                    
                    <div class="flex gap-2 mb-6">
                        <span class="text-xs px-2 py-1 rounded bg-green-500/20 text-green-400 font-bold border border-green-500/20">
                            Save <span id="totalSavings">Rp 0</span>
                        </span>
                        <span class="text-xs px-2 py-1 rounded bg-indigo-500/20 text-indigo-400 font-bold border border-indigo-500/20">
                            <span id="totalLessonsCount">0</span> Lessons
                        </span>
                    </div>

                    <!-- Installment Info -->
                    <div class="bg-slate-900/50 rounded-xl p-3 border border-white/5 mb-6">
                        <div class="flex justify-between items-center mb-2">
                            <span class="text-xs text-muted font-semibold">Cicilan 0% (Est)</span>
                            <span class="text-[10px] text-indigo-400 bg-indigo-500/10 px-1.5 py-0.5 rounded border border-indigo-500/20">PROMO</span>
                        </div>
                        <div class="grid grid-cols-3 gap-2 text-center">
                            <div class="bg-white/5 rounded p-1">
                                <div class="text-[10px] text-muted">3x</div>
                                <div id="inst3" class="text-xs font-bold">0</div>
                            </div>
                            <div class="bg-white/5 rounded p-1">
                                <div class="text-[10px] text-muted">6x</div>
                                <div id="inst6" class="text-xs font-bold">0</div>
                            </div>
                            <div class="bg-white/5 rounded p-1">
                                <div class="text-[10px] text-muted">12x</div>
                                <div id="inst12" class="text-xs font-bold">0</div>
                            </div>
                        </div>
                    </div>

                    <button onclick="openInvoiceModal()" class="btn-nebula w-full text-lg">
                        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Generate Invoice
                    </button>
                </div>
            </div>

            <!-- Skill Radar Chart (New Feature) -->
            <div class="glass-card p-5">
                <div class="flex justify-between items-center mb-4">
                    <h4 class="font-bold text-sm">üß¨ Skill Growth Projection</h4>
                    <span class="text-[10px] text-muted bg-white/5 px-2 py-1 rounded">AI Analysis</span>
                </div>
                <div class="relative h-[220px]">
                    <canvas id="skillRadar"></canvas>
                </div>
                <div class="mt-3 text-center text-xs text-muted">
                    Based on selected curriculum focus
                </div>
            </div>

            <!-- Quick Distribution -->
             <div class="glass-card p-5">
                <h4 class="font-bold text-sm mb-3">üì¶ Package Composition</h4>
                <div class="flex gap-2 overflow-x-auto pb-1 no-scrollbar" id="packagePills">
                    <span class="text-xs text-muted italic">No packages selected</span>
                </div>
            </div>

        </div>
    </main>

    <!-- Budget Optimizer Modal -->
    <div id="budgetModal" class="modal-overlay">
        <div class="modal-box p-8 glass-card">
            <div class="flex justify-between items-center mb-6">
                <div>
                    <h2 class="text-2xl font-display font-bold">üí∞ Budget Optimizer</h2>
                    <p class="text-sm text-muted">Let AI build the best package for you.</p>
                </div>
                <button onclick="closeModal('budgetModal')" class="text-muted hover:text-white text-2xl">&times;</button>
            </div>
            
            <div class="mb-6">
                <label class="block text-sm font-bold text-muted uppercase mb-2">Your Max Budget</label>
                <div class="relative">
                    <span class="absolute left-4 top-3.5 text-muted">Rp</span>
                    <input type="number" id="budgetInput" class="input-modern pl-10 text-lg" placeholder="e.g. 5000000">
                </div>
                <div class="flex gap-2 mt-3">
                    <button onclick="setBudget(3000000)" class="text-xs bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-full border border-white/10 transition">3 Jt</button>
                    <button onclick="setBudget(6000000)" class="text-xs bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-full border border-white/10 transition">6 Jt</button>
                    <button onclick="setBudget(10000000)" class="text-xs bg-white/5 hover:bg-white/10 px-3 py-1.5 rounded-full border border-white/10 transition">10 Jt</button>
                </div>
            </div>

            <button onclick="runBudgetAI()" class="btn-nebula w-full">
                <span>‚ö°</span> Auto-Generate Best Value
            </button>
        </div>
    </div>

    <!-- Invoice Modal & Print Area -->
    <div id="invoiceModal" class="modal-overlay">
        <div class="modal-box p-0 overflow-hidden bg-white text-slate-900">
            <!-- Modal Header (Web Only) -->
            <div class="bg-slate-900 text-white p-5 flex justify-between items-center no-print">
                <h3 class="font-bold text-lg">Invoice Preview</h3>
                <button onclick="closeModal('invoiceModal')" class="text-white/50 hover:text-white">&times;</button>
            </div>

            <!-- Printable Area (A4 Style) -->
            <div id="print-area" class="p-10 bg-white text-slate-900 w-full">
                <!-- Header -->
                <div class="flex justify-between items-start border-b-2 border-slate-100 pb-8 mb-8">
                    <div class="flex gap-4 items-center">
                        <img src="https://learn.algonova.id/uploads/2025/03/Logo_0_1742462072.svg?t=1742462072" alt="Logo" class="w-16 h-16 object-contain">
                        <div>
                            <h1 class="text-2xl font-black text-slate-800 tracking-tight">INVOICE</h1>
                            <p class="text-sm text-slate-500 font-medium">Algonova by Algorithmics</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div id="qr-target"></div>
                        <p class="text-[10px] text-slate-400 mt-1 uppercase tracking-wider font-bold">Scan to Verify</p>
                    </div>
                </div>

                <!-- Client Info -->
                <div class="flex justify-between mb-10">
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Bill To</p>
                        <input type="text" id="invStudentName" placeholder="Student Name..." class="text-xl font-bold text-slate-900 border-none outline-none placeholder-slate-300 w-full">
                        <p class="text-sm text-slate-500 mt-1" id="invDate">Date: -</p>
                    </div>
                    <div class="text-right">
                         <p class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">Payment Method</p>
                         <div class="text-lg font-bold text-slate-800">Bank Transfer / QRIS</div>
                         <p class="text-sm text-slate-500">Via Xendit Gateway</p>
                    </div>
                </div>

                <!-- Table -->
                <table class="w-full mb-10 border-collapse">
                    <thead>
                        <tr class="bg-slate-50 border-y border-slate-200">
                            <th class="py-3 px-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Description</th>
                            <th class="py-3 px-4 text-left text-xs font-bold text-slate-500 uppercase tracking-wider">Type</th>
                            <th class="py-3 px-4 text-center text-xs font-bold text-slate-500 uppercase tracking-wider">Lessons</th>
                            <th class="py-3 px-4 text-right text-xs font-bold text-slate-500 uppercase tracking-wider">Amount</th>
                        </tr>
                    </thead>
                    <tbody id="invoiceTableBody" class="text-sm text-slate-700">
                        <!-- Items injected here -->
                    </tbody>
                </table>

                <!-- Totals -->
                <div class="flex justify-end mb-12">
                    <div class="w-1/2 bg-slate-50 p-6 rounded-lg">
                         <div class="flex justify-between mb-2 text-slate-500">
                            <span>Subtotal</span>
                            <span id="invSubtotal">Rp 0</span>
                        </div>
                        <div class="flex justify-between mb-4 text-green-600 font-medium">
                            <span>Discount Applied</span>
                            <span id="invSavings">- Rp 0</span>
                        </div>
                        <div class="flex justify-between pt-4 border-t border-slate-200">
                            <span class="text-lg font-bold text-slate-900">Total</span>
                            <span class="text-2xl font-black text-indigo-600" id="invTotal">Rp 0</span>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="text-center border-t border-slate-100 pt-8">
                    <p class="text-slate-500 text-sm mb-2">Thank you for investing in the future!</p>
                    <p class="text-[10px] text-slate-400">Generated by Algonova Nebula System v4.0</p>
                </div>
            </div>

            <!-- Actions (Web Only) -->
            <div class="bg-slate-100 p-5 flex justify-end gap-3 no-print border-t border-slate-200">
                <button onclick="window.print()" class="btn-nebula shadow-none">üñ®Ô∏è Print Invoice</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA LAYER ---
        const priceDB = {
            group: {
                np: { 10: 1890000, 20: 3580000, 40: 6760000, 80: 12720000, 120: 16680000 },
                nd: { 10: 1590000, 20: 2980000, 40: 5560000, 80: 10320000, 120: 14280000 },
                tcp: { 10: 1390000, 20: 2580000, 40: 4760000, 80: 8720000, 120: 11880000 },
                kop: { 10: 1350000, 20: 2500000, 40: 4240000, 80: 6960000, 120: 9240000 }
            },
            private: {
                np: { 10: 3900000, 20: 7380000, 40: 13960000, 80: 26240000, 120: 36960000 },
                nd: { 10: 3080000, 20: 5740000, 40: 10680000, 80: 19680000, 120: 27120000 },
                tcp: { 10: 2670000, 20: 4920000, 40: 9040000, 80: 16400000, 120: 22200000 },
                kop: { 10: 2590000, 20: 4780000, 40: 7960000, 80: 14320000, 120: 19080000 }
            },
            premium: {
                np: { 10: 2400000, 20: 4540000, 40: 8560000, 80: 16160000, 120: 21240000 },
                nd: { 10: 2020000, 20: 3780000, 40: 7080000, 80: 13120000, 120: 18120000 },
                tcp: { 10: 1770000, 20: 3280000, 40: 6040000, 80: 11120000, 120: 15120000 },
                kop: { 10: 1710000, 20: 3180000, 40: 5400000, 80: 8800000, 120: 11760000 }
            }
        };

        const courses = [
            { id: "ck", name: "Coding Knight", icon: "‚öîÔ∏è", age: [5,6], cat: "game", skills: {logic: 4, creative: 8, math: 2, tech: 5} },
            { id: "dl", name: "Digital Literacy", icon: "üì±", age: [7], cat: "tech", skills: {logic: 3, creative: 5, math: 2, tech: 9} },
            { id: "vp", name: "Visual Programming", icon: "üß©", age: [8,9,10,11,12], cat: "coding", skills: {logic: 8, creative: 6, math: 5, tech: 7} },
            { id: "gd", name: "Graphic Design", icon: "üé®", age: [9,10,11,12,13,14], cat: "design", skills: {logic: 2, creative: 10, math: 3, tech: 6} },
            { id: "gamedev", name: "Game Development", icon: "üéÆ", age: [10,11,12,13], cat: "game", skills: {logic: 7, creative: 9, math: 4, tech: 8} },
            { id: "py", name: "Python Pro", icon: "üêç", age: [13,14,15,16,17], cat: "coding", skills: {logic: 10, creative: 4, math: 7, tech: 9} },
            { id: "math", name: "Math Master", icon: "üìê", age: [6,7,8,9,10,11,12], cat: "math", skills: {logic: 9, creative: 2, math: 10, tech: 1} },
            { id: "ai", name: "Artificial Intelligence", icon: "ü§ñ", age: [12,13,14,15,16], cat: "tech", skills: {logic: 8, creative: 5, math: 6, tech: 10} }
        ];

        let radarChart = null;

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', () => {
            renderPackages(4);
            initChart();
            initTiltEffect();
            
            // Set Date
            const d = new Date();
            document.getElementById('invDate').innerText = `Date: ${d.toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'})}`;
        });

        // --- RENDER LOGIC ---
        function renderPackages(count) {
            const grid = document.getElementById('packagesGrid');
            grid.innerHTML = '';
            
            const courseOptions = courses.map(c => `<option value="${c.id}">${c.icon} ${c.name}</option>`).join('');

            for (let i = 1; i <= count; i++) {
                grid.innerHTML += `
                    <div class="glass-card p-5 tilt-card" id="pkg-${i}">
                        <div class="flex justify-between items-center mb-4 border-b border-white/5 pb-3">
                            <span class="bg-indigo-500/20 text-indigo-300 text-xs font-bold px-2 py-1 rounded">PACKAGE ${i}</span>
                            <button onclick="clearPackage(${i})" class="text-muted hover:text-red-400">&times;</button>
                        </div>
                        
                        <div class="space-y-3">
                            <div>
                                <label class="text-[10px] text-muted font-bold uppercase">Course</label>
                                <select class="input-modern course-select" data-id="${i}" onchange="calc()">
                                    <option value="">Select Course...</option>
                                    ${courseOptions}
                                </select>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] text-muted font-bold uppercase">Class Type</label>
                                    <select class="input-modern class-select" data-id="${i}" onchange="calc()">
                                        <option value="group">üë• Group</option>
                                        <option value="private">üëë Private</option>
                                        <option value="premium">üíé Premium</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] text-muted font-bold uppercase">Pricing</label>
                                    <select class="input-modern type-select" data-id="${i}" onchange="calc()">
                                        <option value="np">Normal</option>
                                        <option value="nd">Diskon</option>
                                        <option value="tcp">Corporate</option>
                                        <option value="kop">KOP</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3">
                                <div>
                                    <label class="text-[10px] text-muted font-bold uppercase">Lessons</label>
                                    <select class="input-modern lesson-select" data-id="${i}" onchange="calc()">
                                        <option value="0">--</option>
                                        <option value="10">10 Sessions</option>
                                        <option value="20">20 Sessions</option>
                                        <option value="40">40 Sessions</option>
                                        <option value="80">80 Sessions</option>
                                        <option value="120">120 Sessions</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-[10px] text-muted font-bold uppercase">Bundle</label>
                                    <select class="input-modern bundle-select" data-id="${i}" onchange="calc()">
                                        <option value="0">None</option>
                                        <option value="0.1">üéÅ -10%</option>
                                    </select>
                                </div>
                            </div>

                            <div class="pt-3 mt-2 border-t border-white/5 flex justify-between items-center">
                                <span class="text-xs text-muted">Price:</span>
                                <span class="text-lg font-bold text-white pkg-price" id="price-${i}">Rp 0</span>
                            </div>
                        </div>
                    </div>
                `;
            }
            initTiltEffect(); // Re-bind hover events
        }

        // --- CALCULATOR ENGINE ---
        function calc() {
            let total = 0;
            let totalLessons = 0;
            let totalBasePrice = 0; // For savings calc
            let activeSkills = { logic:0, creative:0, math:0, tech:0 };
            let packagePillsHTML = '';
            let invoiceItems = [];

            // Loop through all packages
            for (let i = 1; i <= 4; i++) {
                const courseId = document.querySelector(`.course-select[data-id="${i}"]`).value;
                const classType = document.querySelector(`.class-select[data-id="${i}"]`).value;
                const priceType = document.querySelector(`.type-select[data-id="${i}"]`).value;
                const lessons = parseInt(document.querySelector(`.lesson-select[data-id="${i}"]`).value);
                const discount = parseFloat(document.querySelector(`.bundle-select[data-id="${i}"]`).value);

                const priceEl = document.getElementById(`price-${i}`);

                if (courseId && lessons > 0) {
                    // Get Base Price
                    let basePrice = priceDB[classType][priceType][lessons] || 0;
                    
                    // Apply Bundle Discount
                    let finalPrice = basePrice - (basePrice * discount);
                    
                    // Update UI
                    priceEl.innerText = formatIDR(finalPrice);
                    
                    // Accumulate Stats
                    total += finalPrice;
                    totalBasePrice += (priceDB[classType]['np'][lessons] || basePrice); // Compare against Normal Price
                    totalLessons += lessons;

                    // Skill Accumulation
                    const courseData = courses.find(c => c.id === courseId);
                    if (courseData) {
                        activeSkills.logic += (courseData.skills.logic * lessons) / 10;
                        activeSkills.creative += (courseData.skills.creative * lessons) / 10;
                        activeSkills.math += (courseData.skills.math * lessons) / 10;
                        activeSkills.tech += (courseData.skills.tech * lessons) / 10;

                        packagePillsHTML += `<span class="px-2 py-1 rounded-md bg-white/10 text-xs whitespace-nowrap border border-white/5">${courseData.icon} ${lessons}x</span>`;
                        
                        invoiceItems.push({
                            name: courseData.name,
                            type: `${classType.toUpperCase()} - ${priceType.toUpperCase()}`,
                            lessons: lessons,
                            price: finalPrice
                        });
                    }
                } else {
                    priceEl.innerText = "Rp 0";
                }
            }

            // Update Header & Grand Total
            document.getElementById('grandTotal').innerText = formatIDR(total);
            document.getElementById('headerTotal').innerText = formatIDR(total);
            document.getElementById('totalLessonsCount').innerText = totalLessons;
            document.getElementById('totalSavings').innerText = formatIDR(totalBasePrice - total);
            
            // Update Package Pills
            document.getElementById('packagePills').innerHTML = packagePillsHTML || '<span class="text-xs text-muted italic">No packages selected</span>';

            // Update Installments
            document.getElementById('inst3').innerText = formatIDR(total / 3);
            document.getElementById('inst6').innerText = formatIDR(total / 6);
            document.getElementById('inst12').innerText = formatIDR(total / 12);

            // Update Chart
            updateRadar(activeSkills);

            // Store for Invoice
            window.currentInvoiceData = { total, savings: totalBasePrice - total, items: invoiceItems };
        }

        // --- SMART CHART (Radar) ---
        function initChart() {
            const ctx = document.getElementById('skillRadar');
            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
            
            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Logic & Algo', 'Creativity', 'Mathematics', 'Technology'],
                    datasets: [{
                        label: 'Skill Projection',
                        data: [0, 0, 0, 0],
                        backgroundColor: 'rgba(99, 102, 241, 0.4)',
                        borderColor: '#818cf8',
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#fff',
                        borderWidth: 2
                    }]
                },
                options: {
                    scales: {
                        r: {
                            angleLines: { color: 'rgba(255,255,255,0.1)' },
                            grid: { color: 'rgba(255,255,255,0.05)' },
                            pointLabels: { font: { size: 10, weight: 'bold' }, color: '#cbd5e1' },
                            suggestedMin: 0,
                            suggestedMax: 20,
                            ticks: { display: false }
                        }
                    },
                    plugins: { legend: { display: false } },
                    maintainAspectRatio: false
                }
            });
        }

        function updateRadar(skills) {
            radarChart.data.datasets[0].data = [skills.logic, skills.creative, skills.math, skills.tech];
            radarChart.update();
        }

        // --- AI RECOMMENDATIONS ---
        function updateRecommendations() {
            const age = parseInt(document.getElementById('childAge').value);
            const interest = document.getElementById('childInterest').value;
            const container = document.getElementById('recommendationsOutput');

            if (!age) {
                container.innerHTML = `<div class="col-span-full text-center py-8 text-muted text-sm border border-dashed border-white/10 rounded-xl">Enter age to see magic ‚ú®</div>`;
                return;
            }

            // Filter logic
            let matched = courses.filter(c => c.age.includes(age));
            if (interest !== 'any') {
                matched = matched.filter(c => c.cat === interest);
            }

            // Fallback if interest too specific
            if (matched.length === 0) matched = courses.filter(c => c.age.includes(age)).slice(0, 2);

            const html = matched.map(c => `
                <div onclick="autoFill('${c.id}')" class="glass-card p-3 cursor-pointer hover:bg-white/5 transition border border-l-4 border-l-indigo-500 border-y-0 border-r-0">
                    <div class="flex items-center gap-3">
                        <span class="text-2xl">${c.icon}</span>
                        <div>
                            <div class="font-bold text-sm text-white">${c.name}</div>
                            <div class="text-[10px] text-muted">Fit for ${age}y ‚Ä¢ ${c.cat.toUpperCase()}</div>
                        </div>
                        <span class="ml-auto text-indigo-400 text-xs font-bold">+ Add</span>
                    </div>
                </div>
            `).join('');

            container.innerHTML = html || `<div class="text-muted text-xs p-4">No specific courses found. Try "All Interests".</div>`;
        }

        function autoFill(courseId) {
            // Find first empty slot
            for (let i = 1; i <= 4; i++) {
                const sel = document.querySelector(`.course-select[data-id="${i}"]`);
                if (sel.value === "") {
                    sel.value = courseId;
                    document.querySelector(`.lesson-select[data-id="${i}"]`).value = "40"; // Default nice value
                    calc();
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#6366f1', '#a855f7'] });
                    return;
                }
            }
            alert("All slots full! Clear a package first.");
        }

        // --- BUDGET AI (The Amazing Feature) ---
        function openBudgetModal() {
            document.getElementById('budgetModal').classList.add('active');
        }
        function setBudget(val) {
            document.getElementById('budgetInput').value = val;
        }
        
        function runBudgetAI() {
            const budget = parseInt(document.getElementById('budgetInput').value);
            if (!budget) return;

            resetAll(); // Clear first
            
            // Simple Greedy Algo to find best single or double package fitting budget
            // Priority: Higher lessons -> Group Class -> Normal Price
            
            let bestCombo = null;
            let minDiff = Infinity;

            // Try to find a Group NP package closest to budget
            Object.keys(priceDB.group.np).forEach(lessons => {
                const price = priceDB.group.np[lessons];
                const diff = budget - price;
                if (diff >= 0 && diff < minDiff) {
                    minDiff = diff;
                    bestCombo = { type: 'group', priceType: 'np', lessons: lessons };
                }
            });

            if (bestCombo) {
                document.querySelector(`.course-select[data-id="1"]`).value = "vp"; // Default course
                document.querySelector(`.class-select[data-id="1"]`).value = bestCombo.type;
                document.querySelector(`.type-select[data-id="1"]`).value = bestCombo.priceType;
                document.querySelector(`.lesson-select[data-id="1"]`).value = bestCombo.lessons;
                
                calc();
                closeModal('budgetModal');
                confetti({ particleCount: 150, spread: 100 });
            } else {
                alert("Budget too low for available packages.");
            }
        }

        // --- INVOICE SYSTEM ---
        function openInvoiceModal() {
            if(!window.currentInvoiceData || window.currentInvoiceData.total === 0) {
                alert("Please select packages first!");
                return;
            }
            
            const data = window.currentInvoiceData;
            const tbody = document.getElementById('invoiceTableBody');
            tbody.innerHTML = '';

            data.items.forEach(item => {
                tbody.innerHTML += `
                    <tr class="border-b border-slate-100">
                        <td class="py-3 px-4 font-medium text-slate-800">${item.name}</td>
                        <td class="py-3 px-4 text-slate-500 text-xs">${item.type}</td>
                        <td class="py-3 px-4 text-center text-slate-600">${item.lessons}</td>
                        <td class="py-3 px-4 text-right font-bold text-slate-800">${formatIDR(item.price)}</td>
                    </tr>
                `;
            });

            document.getElementById('invSubtotal').innerText = formatIDR(data.total + data.savings);
            document.getElementById('invSavings').innerText = "- " + formatIDR(data.savings);
            document.getElementById('invTotal').innerText = formatIDR(data.total);

            // Generate QR
            document.getElementById('qr-target').innerHTML = "";
            new QRCode(document.getElementById("qr-target"), {
                text: `ALGONOVA-${Date.now()}-${data.total}`,
                width: 64, height: 64,
                colorDark : "#000000", colorLight : "#ffffff"
            });

            document.getElementById('invoiceModal').classList.add('active');
        }

        // --- UTILS ---
        function formatIDR(num) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', maximumFractionDigits: 0 }).format(num);
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function resetAll() {
            document.querySelectorAll('select').forEach(s => s.selectedIndex = 0);
            document.querySelectorAll('.course-select').forEach(s => s.value = "");
            document.querySelectorAll('.class-select').forEach(s => s.value = "group");
            document.querySelectorAll('.type-select').forEach(s => s.value = "np");
            calc();
        }

        function clearPackage(id) {
            document.querySelector(`.course-select[data-id="${id}"]`).value = "";
            document.querySelector(`.lesson-select[data-id="${id}"]`).value = "0";
            calc();
        }

        function toggleTheme() {
            const html = document.documentElement;
            const current = html.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            html.setAttribute('data-theme', next);
            document.getElementById('themeIcon').innerText = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }

        // --- 3D TILT EFFECT (Vanilla JS) ---
        function initTiltEffect() {
            const cards = document.querySelectorAll('.tilt-card');
            
            cards.forEach(card => {
                card.addEventListener('mousemove', (e) => {
                    const rect = card.getBoundingClientRect();
                    const x = e.clientX - rect.left;
                    const y = e.clientY - rect.top;
                    
                    const centerX = rect.width / 2;
                    const centerY = rect.height / 2;
                    
                    const rotateX = ((y - centerY) / centerY) * -5; // Max rotation deg
                    const rotateY = ((x - centerX) / centerX) * 5;

                    card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
                });

                card.addEventListener('mouseleave', () => {
                    card.style.transform = `perspective(1000px) rotateX(0) rotateY(0)`;
                });
            });
        }

    </script>
</body>
</html>
